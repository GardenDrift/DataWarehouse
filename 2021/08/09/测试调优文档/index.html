<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    

    
    <title>测试调优文档 | Hexo</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="" />
    
    <meta name="description" content="测试调优文档 1. spark基准测试1.1 测试方式1.1.1 TPC-DS1.1.2 Hibench1.2 测试结果1.2.1 TPC-DS1.2.1.1 100g数据产生12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596">
<meta property="og:type" content="article">
<meta property="og:title" content="测试调优文档">
<meta property="og:url" content="http://example.com/2021/08/09/%E6%B5%8B%E8%AF%95%E8%B0%83%E4%BC%98%E6%96%87%E6%A1%A3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="测试调优文档 1. spark基准测试1.1 测试方式1.1.1 TPC-DS1.1.2 Hibench1.2 测试结果1.2.1 TPC-DS1.2.1.1 100g数据产生12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2021/08/09/%E6%B5%8B%E8%AF%95%E8%B0%83%E4%BC%98%E6%96%87%E6%A1%A3/typora-user-images%5Cimage-20210807101902090-1628485681448.png">
<meta property="article:published_time" content="2021-08-09T04:58:35.000Z">
<meta property="article:modified_time" content="2021-08-09T05:31:09.706Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2021/08/09/%E6%B5%8B%E8%AF%95%E8%B0%83%E4%BC%98%E6%96%87%E6%A1%A3/typora-user-images%5Cimage-20210807101902090-1628485681448.png">
    

    
        <link rel="alternate" href="/" title="Hexo" type="application/atom+xml" />
    

    

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/libs/titillium-web/styles.css">

    
<link rel="stylesheet" href="/libs/source-code-pro/styles.css">


    
<link rel="stylesheet" href="/css/style.css">


    
<script src="/libs/jquery/3.5.0/jquery.min.js"></script>

    
    
        
<link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">

    
    
        
<link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">

    
    
    
    


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">Home</a>
                                </li>
                            
                                    
                                
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/about/index.html">About</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    uncategorized
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-测试调优文档" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        测试调优文档
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2021/08/09/%E6%B5%8B%E8%AF%95%E8%B0%83%E4%BC%98%E6%96%87%E6%A1%A3/" class="article-date">
       <time datetime="2021-08-09T04:58:35.000Z" itemprop="datePublished">2021-08-09</time>
    </a>
  </div>


<div class="article-date">
  <i class="fa fa-calendar-plus-o"></i>
  <a href="/2021/08/09/%E6%B5%8B%E8%AF%95%E8%B0%83%E4%BC%98%E6%96%87%E6%A1%A3/" class="article-date">
     <time datetime="2021-08-09T05:31:09.706Z" itemprop="dateModified">2021-08-09</time>
  </a>
</div>


                

                
                

                

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            

            

            

            <meta name="referrer" content="no-referrer"/>

<h1 id="测试调优文档"><a href="#测试调优文档" class="headerlink" title="测试调优文档"></a>测试调优文档</h1><p><img src="./typora-user-images%5Cimage-20210807101902090-1628485681448.png" alt="image-20210807102236216"></p>
<h2 id="1-spark基准测试"><a href="#1-spark基准测试" class="headerlink" title="1. spark基准测试"></a>1. spark基准测试</h2><h3 id="1-1-测试方式"><a href="#1-1-测试方式" class="headerlink" title="1.1 测试方式"></a>1.1 测试方式</h3><h4 id="1-1-1-TPC-DS"><a href="#1-1-1-TPC-DS" class="headerlink" title="1.1.1 TPC-DS"></a>1.1.1 TPC-DS</h4><h4 id="1-1-2-Hibench"><a href="#1-1-2-Hibench" class="headerlink" title="1.1.2 Hibench"></a>1.1.2 Hibench</h4><h3 id="1-2-测试结果"><a href="#1-2-测试结果" class="headerlink" title="1.2 测试结果"></a>1.2 测试结果</h3><h4 id="1-2-1-TPC-DS"><a href="#1-2-1-TPC-DS" class="headerlink" title="1.2.1 TPC-DS"></a>1.2.1 TPC-DS</h4><h5 id="1-2-1-1-100g数据产生"><a href="#1-2-1-1-100g数据产生" class="headerlink" title="1.2.1.1 100g数据产生"></a>1.2.1.1 100g数据产生</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line">[yuanlin@emr-header-1 hive-testbench]$ ./tpcds-setup.sh $SF</span><br><span class="line">ls: `/tmp/tpcds-generate/100&#x27;: No such file or directory</span><br><span class="line">Generating data at scale factor 100.</span><br><span class="line">21/08/02 11:21:46 INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = false, remoteHostTrusted = false</span><br><span class="line">21/08/02 11:21:46 INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = false, remoteHostTrusted = false</span><br><span class="line">21/08/02 11:21:46 INFO Configuration.deprecation: mapred.task.timeout is deprecated. Instead, use mapreduce.task.timeout</span><br><span class="line">21/08/02 11:21:47 INFO client.AHSProxy: Connecting to Application History server at emr-header-1.cluster-232810/172.16.0.181:10200</span><br><span class="line">21/08/02 11:21:47 INFO hdfs.DFSClient: Created token for yuanlin: HDFS_DELEGATION_TOKEN owner=yuanlin@EMR.232810.COM, renewer=yarn, realUser=, issueDate=1627874507165, maxDate=1628479307165, sequenceNumber=9595, masterKeyId=61 on ha-hdfs:emr-cluster</span><br><span class="line">21/08/02 11:21:47 INFO security.TokenCache: Got dt for hdfs://emr-cluster; Kind: HDFS_DELEGATION_TOKEN, Service: ha-hdfs:emr-cluster, Ident: (token for yuanlin: HDFS_DELEGATION_TOKEN owner=yuanlin@EMR.232810.COM, renewer=yarn, realUser=, issueDate=1627874507165, maxDate=1628479307165, sequenceNumber=9595, masterKeyId=61)</span><br><span class="line">21/08/02 11:21:47 INFO mapreduce.JobResourceUploader: Disabling Erasure Coding for path: /tmp/hadoop-yarn/staging/yuanlin/.staging/job_1627367157851_1334</span><br><span class="line">21/08/02 11:21:47 INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = false, remoteHostTrusted = false</span><br><span class="line">21/08/02 11:21:47 INFO input.FileInputFormat: Total input files to process : 1</span><br><span class="line">21/08/02 11:21:47 INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = false, remoteHostTrusted = false</span><br><span class="line">21/08/02 11:21:47 INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = false, remoteHostTrusted = false</span><br><span class="line">21/08/02 11:21:47 INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = false, remoteHostTrusted = false</span><br><span class="line">21/08/02 11:21:47 INFO mapreduce.JobSubmitter: number of splits:100</span><br><span class="line">21/08/02 11:21:47 INFO Configuration.deprecation: io.sort.mb is deprecated. Instead, use mapreduce.task.io.sort.mb</span><br><span class="line">21/08/02 11:21:47 INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = false, remoteHostTrusted = false</span><br><span class="line">21/08/02 11:21:47 INFO mapreduce.JobSubmitter: Submitting tokens for job: job_1627367157851_1334</span><br><span class="line">21/08/02 11:21:47 INFO mapreduce.JobSubmitter: Executing with tokens: [Kind: HDFS_DELEGATION_TOKEN, Service: ha-hdfs:emr-cluster, Ident: (token for yuanlin: HDFS_DELEGATION_TOKEN owner=yuanlin@EMR.232810.COM, renewer=yarn, realUser=, issueDate=1627874507165, maxDate=1628479307165, sequenceNumber=9595, masterKeyId=61)]</span><br><span class="line">21/08/02 11:21:47 INFO conf.Configuration: resource-types.xml not found</span><br><span class="line">21/08/02 11:21:47 INFO resource.ResourceUtils: Unable to find &#x27;resource-types.xml&#x27;.</span><br><span class="line">21/08/02 11:21:47 INFO impl.TimelineClientImpl: Timeline service address: emr-header-1.cluster-232810:8188</span><br><span class="line">21/08/02 11:21:48 INFO impl.YarnClientImpl: Submitted application application_1627367157851_1334</span><br><span class="line">21/08/02 11:21:48 INFO mapreduce.Job: The url to track the job: http://emr-header-1.cluster-232810:20888/proxy/application_1627367157851_1334/</span><br><span class="line">21/08/02 11:21:48 INFO mapreduce.Job: Running job: job_1627367157851_1334</span><br><span class="line">21/08/02 11:21:55 INFO mapreduce.Job: Job job_1627367157851_1334 running in uber mode : false</span><br><span class="line">21/08/02 11:21:55 INFO mapreduce.Job:  map 0% reduce 0%</span><br><span class="line">21/08/02 11:23:21 INFO mapreduce.Job:  map 5% reduce 0%</span><br><span class="line">21/08/02 11:23:22 INFO mapreduce.Job:  map 6% reduce 0%</span><br><span class="line">21/08/02 11:23:23 INFO mapreduce.Job:  map 8% reduce 0%</span><br><span class="line">21/08/02 11:23:24 INFO mapreduce.Job:  map 10% reduce 0%</span><br><span class="line">21/08/02 11:23:26 INFO mapreduce.Job:  map 11% reduce 0%</span><br><span class="line">21/08/02 11:23:27 INFO mapreduce.Job:  map 14% reduce 0%</span><br><span class="line">21/08/02 11:23:29 INFO mapreduce.Job:  map 19% reduce 0%</span><br><span class="line">21/08/02 11:23:34 INFO mapreduce.Job:  map 20% reduce 0%</span><br><span class="line">21/08/02 11:23:35 INFO mapreduce.Job:  map 21% reduce 0%</span><br><span class="line">21/08/02 11:23:41 INFO mapreduce.Job:  map 22% reduce 0%</span><br><span class="line">21/08/02 11:23:42 INFO mapreduce.Job:  map 23% reduce 0%</span><br><span class="line">21/08/02 11:23:43 INFO mapreduce.Job:  map 24% reduce 0%</span><br><span class="line">21/08/02 11:23:45 INFO mapreduce.Job:  map 25% reduce 0%</span><br><span class="line">21/08/02 11:23:46 INFO mapreduce.Job:  map 26% reduce 0%</span><br><span class="line">21/08/02 11:23:49 INFO mapreduce.Job:  map 27% reduce 0%</span><br><span class="line">21/08/02 11:24:43 INFO mapreduce.Job:  map 30% reduce 0%</span><br><span class="line">21/08/02 11:24:44 INFO mapreduce.Job:  map 33% reduce 0%</span><br><span class="line">21/08/02 11:24:45 INFO mapreduce.Job:  map 34% reduce 0%</span><br><span class="line">21/08/02 11:24:47 INFO mapreduce.Job:  map 36% reduce 0%</span><br><span class="line">21/08/02 11:24:51 INFO mapreduce.Job:  map 38% reduce 0%</span><br><span class="line">21/08/02 11:24:52 INFO mapreduce.Job:  map 39% reduce 0%</span><br><span class="line">21/08/02 11:24:53 INFO mapreduce.Job:  map 40% reduce 0%</span><br><span class="line">21/08/02 11:24:54 INFO mapreduce.Job:  map 43% reduce 0%</span><br><span class="line">21/08/02 11:24:55 INFO mapreduce.Job:  map 45% reduce 0%</span><br><span class="line">21/08/02 11:24:56 INFO mapreduce.Job:  map 46% reduce 0%</span><br><span class="line">21/08/02 11:25:00 INFO mapreduce.Job:  map 47% reduce 0%</span><br><span class="line">21/08/02 11:25:02 INFO mapreduce.Job:  map 48% reduce 0%</span><br><span class="line">21/08/02 11:25:11 INFO mapreduce.Job:  map 49% reduce 0%</span><br><span class="line">21/08/02 11:25:12 INFO mapreduce.Job:  map 50% reduce 0%</span><br><span class="line">21/08/02 11:25:14 INFO mapreduce.Job:  map 51% reduce 0%</span><br><span class="line">21/08/02 11:25:15 INFO mapreduce.Job:  map 53% reduce 0%</span><br><span class="line">21/08/02 11:25:19 INFO mapreduce.Job:  map 54% reduce 0%</span><br><span class="line">21/08/02 11:26:04 INFO mapreduce.Job:  map 55% reduce 0%</span><br><span class="line">21/08/02 11:26:05 INFO mapreduce.Job:  map 58% reduce 0%</span><br><span class="line">21/08/02 11:26:06 INFO mapreduce.Job:  map 59% reduce 0%</span><br><span class="line">21/08/02 11:26:07 INFO mapreduce.Job:  map 60% reduce 0%</span><br><span class="line">21/08/02 11:26:08 INFO mapreduce.Job:  map 61% reduce 0%</span><br><span class="line">21/08/02 11:26:09 INFO mapreduce.Job:  map 62% reduce 0%</span><br><span class="line">21/08/02 11:26:11 INFO mapreduce.Job:  map 63% reduce 0%</span><br><span class="line">21/08/02 11:26:14 INFO mapreduce.Job:  map 64% reduce 0%</span><br><span class="line">21/08/02 11:26:15 INFO mapreduce.Job:  map 65% reduce 0%</span><br><span class="line">21/08/02 11:26:18 INFO mapreduce.Job:  map 69% reduce 0%</span><br><span class="line">21/08/02 11:26:19 INFO mapreduce.Job:  map 71% reduce 0%</span><br><span class="line">21/08/02 11:26:20 INFO mapreduce.Job:  map 72% reduce 0%</span><br><span class="line">21/08/02 11:26:21 INFO mapreduce.Job:  map 73% reduce 0%</span><br><span class="line">21/08/02 11:26:26 INFO mapreduce.Job:  map 75% reduce 0%</span><br><span class="line">21/08/02 11:26:38 INFO mapreduce.Job:  map 76% reduce 0%</span><br><span class="line">21/08/02 11:26:41 INFO mapreduce.Job:  map 77% reduce 0%</span><br><span class="line">21/08/02 11:26:43 INFO mapreduce.Job:  map 79% reduce 0%</span><br><span class="line">21/08/02 11:26:44 INFO mapreduce.Job:  map 80% reduce 0%</span><br><span class="line">21/08/02 11:26:48 INFO mapreduce.Job:  map 81% reduce 0%</span><br><span class="line">21/08/02 11:27:26 INFO mapreduce.Job:  map 83% reduce 0%</span><br><span class="line">21/08/02 11:27:27 INFO mapreduce.Job:  map 85% reduce 0%</span><br><span class="line">21/08/02 11:27:29 INFO mapreduce.Job:  map 87% reduce 0%</span><br><span class="line">21/08/02 11:27:31 INFO mapreduce.Job:  map 89% reduce 0%</span><br><span class="line">21/08/02 11:27:32 INFO mapreduce.Job:  map 90% reduce 0%</span><br><span class="line">21/08/02 11:27:37 INFO mapreduce.Job:  map 91% reduce 0%</span><br><span class="line">21/08/02 11:27:40 INFO mapreduce.Job:  map 92% reduce 0%</span><br><span class="line">21/08/02 11:27:41 INFO mapreduce.Job:  map 96% reduce 0%</span><br><span class="line">21/08/02 11:27:42 INFO mapreduce.Job:  map 97% reduce 0%</span><br><span class="line">21/08/02 11:27:43 INFO mapreduce.Job:  map 98% reduce 0%</span><br><span class="line">21/08/02 11:27:44 INFO mapreduce.Job:  map 99% reduce 0%</span><br><span class="line">21/08/02 11:27:53 INFO mapreduce.Job:  map 100% reduce 0%</span><br><span class="line">21/08/02 11:27:54 INFO mapreduce.Job: Job job_1627367157851_1334 completed successfully</span><br><span class="line">21/08/02 11:27:54 INFO mapreduce.Job: Counters: 34</span><br><span class="line">	File System Counters</span><br><span class="line">		FILE: Number of bytes read=0</span><br><span class="line">		FILE: Number of bytes written=25431690</span><br><span class="line">		FILE: Number of read operations=0</span><br><span class="line">		FILE: Number of large read operations=0</span><br><span class="line">		FILE: Number of write operations=0</span><br><span class="line">		HDFS: Number of bytes read=284773</span><br><span class="line">		HDFS: Number of bytes written=103421111819</span><br><span class="line">		HDFS: Number of read operations=3645</span><br><span class="line">		HDFS: Number of large read operations=0</span><br><span class="line">		HDFS: Number of write operations=2055</span><br><span class="line">		HDFS: Number of bytes read erasure-coded=0</span><br><span class="line">	Job Counters </span><br><span class="line">		Killed map tasks=6</span><br><span class="line">		Launched map tasks=106</span><br><span class="line">		Other local map tasks=106</span><br><span class="line">		Total time spent by all maps in occupied slots (ms)=17123930</span><br><span class="line">		Total time spent by all reduces in occupied slots (ms)=0</span><br><span class="line">		Total time spent by all map tasks (ms)=8561965</span><br><span class="line">		Total vcore-milliseconds taken by all map tasks=8561965</span><br><span class="line">		Total megabyte-milliseconds taken by all map tasks=35069808640</span><br><span class="line">	Map-Reduce Framework</span><br><span class="line">		Map input records=100</span><br><span class="line">		Map output records=0</span><br><span class="line">		Input split bytes=10600</span><br><span class="line">		Spilled Records=0</span><br><span class="line">		Failed Shuffles=0</span><br><span class="line">		Merged Map outputs=0</span><br><span class="line">		GC time elapsed (ms)=15572</span><br><span class="line">		CPU time spent (ms)=2420640</span><br><span class="line">		Physical memory (bytes) snapshot=120923090944</span><br><span class="line">		Virtual memory (bytes) snapshot=534229188608</span><br><span class="line">		Total committed heap usage (bytes)=179312787456</span><br><span class="line">		Peak Map Physical memory (bytes)=1248698368</span><br><span class="line">		Peak Map Virtual memory (bytes)=5371641856</span><br><span class="line">	File Input Format Counters </span><br><span class="line">		Bytes Read=274173</span><br><span class="line">	File Output Format Counters </span><br><span class="line">		Bytes Written=0</span><br><span class="line">TPC-DS text data generation complete.</span><br><span class="line">Loading text data into external tables.</span><br><span class="line">Optimizing table date_dim (1/24).</span><br><span class="line">Optimizing table time_dim (2/24).</span><br><span class="line">Optimizing table item (3/24).</span><br><span class="line">Optimizing table customer (4/24).</span><br><span class="line">Optimizing table customer_demographics (5/24).</span><br><span class="line">Optimizing table household_demographics (6/24).</span><br><span class="line">Optimizing table customer_address (7/24).</span><br><span class="line">Optimizing table store (8/24).</span><br><span class="line">Optimizing table promotion (9/24).</span><br><span class="line">Optimizing table warehouse (10/24).</span><br><span class="line">Optimizing table ship_mode (11/24).</span><br><span class="line">Optimizing table reason (12/24).</span><br><span class="line">Optimizing table income_band (13/24).</span><br><span class="line">Optimizing table call_center (14/24).</span><br><span class="line">Optimizing table web_page (15/24).</span><br><span class="line">Optimizing table catalog_page (16/24).</span><br><span class="line">Optimizing table web_site (17/24).</span><br><span class="line">Optimizing table store_sales (18/24).</span><br><span class="line">Optimizing table store_returns (19/24).</span><br><span class="line">Optimizing table web_sales (20/24).</span><br><span class="line">Optimizing table web_returns (21/24).</span><br><span class="line">Optimizing table catalog_sales (22/24).</span><br><span class="line">Optimizing table catalog_returns (23/24).</span><br><span class="line">Optimizing table inventory (24/24).</span><br><span class="line">Loading constraints</span><br><span class="line">Data loaded into database tpcds_bin_partitioned_orc_100.</span><br></pre></td></tr></table></figure>

<h5 id="1-2-1-2-100g数据查询"><a href="#1-2-1-2-100g数据查询" class="headerlink" title="1.2.1.2 100g数据查询"></a>1.2.1.2 100g数据查询</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">filename,status,time,rows</span><br><span class="line">query10.sql,success,<span class="number">67</span>,<span class="number">100</span></span><br><span class="line">query11.sql,success,<span class="number">148</span>,<span class="number">100</span></span><br><span class="line">query12.sql,success,<span class="number">39</span>,<span class="number">100</span></span><br><span class="line">query13.sql,success,<span class="number">74</span>,<span class="number">1</span></span><br><span class="line">query14.sql,success,<span class="number">638</span>,<span class="number">100</span></span><br><span class="line">query14.sql,success,<span class="number">638</span>,<span class="number">100</span></span><br><span class="line">query15.sql,success,<span class="number">55</span>,<span class="number">100</span></span><br><span class="line">query16.sql,success,<span class="number">196</span>,<span class="number">1</span></span><br><span class="line">query17.sql,success,<span class="number">115</span>,<span class="number">55</span></span><br><span class="line">query18.sql,success,<span class="number">62</span>,<span class="number">100</span></span><br><span class="line">query19.sql,success,<span class="number">49</span>,<span class="number">100</span></span><br><span class="line">query2.sql,success,<span class="number">136</span>,<span class="number">2513</span></span><br><span class="line">query20.sql,success,<span class="number">42</span>,<span class="number">100</span></span><br><span class="line">query21.sql,success,<span class="number">47</span>,<span class="number">100</span></span><br><span class="line">query22.sql,success,<span class="number">205</span>,<span class="number">100</span></span><br><span class="line">query23.sql,success,<span class="number">349</span>,<span class="number">1</span></span><br><span class="line">query23.sql,success,<span class="number">349</span>,<span class="number">100</span></span><br><span class="line">query24.sql,success,<span class="number">346</span>,<span class="number">45</span></span><br><span class="line">query24.sql,success,<span class="number">346</span>,<span class="number">8</span></span><br><span class="line">query25.sql,success,<span class="number">164</span>,<span class="number">13</span></span><br><span class="line">query26.sql,success,<span class="number">156</span>,<span class="number">100</span></span><br><span class="line">query27.sql,success,<span class="number">115</span>,<span class="number">100</span></span><br><span class="line">query28.sql,success,<span class="number">323</span>,<span class="number">1</span></span><br><span class="line">query29.sql,success,<span class="number">551</span>,<span class="number">42</span></span><br><span class="line">query3.sql,success,<span class="number">371</span>,<span class="number">100</span></span><br><span class="line">query30.sql,success,<span class="number">343</span>,<span class="number">100</span></span><br><span class="line">query31.sql,success,<span class="number">378</span>,<span class="number">286</span></span><br><span class="line">query32.sql,success,<span class="number">58</span>,<span class="number">1</span></span><br><span class="line">query33.sql,success,<span class="number">76</span>,<span class="number">100</span></span><br><span class="line">query35.sql,success,<span class="number">88</span>,<span class="number">100</span></span><br><span class="line">query36.sql,success,<span class="number">69</span>,<span class="number">100</span></span><br><span class="line">query37.sql,success,<span class="number">90</span>,<span class="number">3</span></span><br><span class="line">query38.sql,success,<span class="number">192</span>,<span class="number">1</span></span><br><span class="line">query39.sql,success,<span class="number">87</span>,<span class="number">5045</span></span><br><span class="line">query39.sql,success,<span class="number">87</span>,<span class="number">191</span></span><br><span class="line">query4.sql,success,<span class="number">226</span>,<span class="number">100</span></span><br><span class="line">query40.sql,success,<span class="number">97</span>,<span class="number">100</span></span><br><span class="line">query41.sql,success,<span class="number">31</span>,<span class="number">100</span></span><br><span class="line">query42.sql,success,<span class="number">41</span>,<span class="number">11</span></span><br><span class="line">query43.sql,success,<span class="number">57</span>,<span class="number">88</span></span><br><span class="line">query45.sql,success,<span class="number">53</span>,<span class="number">100</span></span><br><span class="line">query46.sql,success,<span class="number">61</span>,<span class="number">100</span></span><br><span class="line">query47.sql,success,<span class="number">61</span>,<span class="number">100</span></span><br><span class="line">query48.sql,success,<span class="number">56</span>,<span class="number">1</span></span><br><span class="line">query49.sql,success,<span class="number">166</span>,<span class="number">100</span></span><br><span class="line">query5.sql,success,<span class="number">183</span>,<span class="number">100</span></span><br><span class="line">query50.sql,success,<span class="number">105</span>,<span class="number">100</span></span><br><span class="line">query51.sql,success,<span class="number">176</span>,<span class="number">100</span></span><br><span class="line">query52.sql,success,<span class="number">42</span>,<span class="number">100</span></span><br><span class="line">query53.sql,success,<span class="number">84</span>,<span class="number">100</span></span><br><span class="line">query54.sql,success,<span class="number">115</span>,<span class="number">6</span></span><br><span class="line">query55.sql,success,<span class="number">41</span>,<span class="number">100</span></span><br><span class="line">query56.sql,success,<span class="number">68</span>,<span class="number">100</span></span><br><span class="line">query57.sql,success,<span class="number">67</span>,<span class="number">100</span></span><br><span class="line">query58.sql,success,<span class="number">67</span>,<span class="number">100</span></span><br><span class="line">query59.sql,success,<span class="number">91</span>,<span class="number">100</span></span><br><span class="line">query6.sql,success,<span class="number">47</span>,<span class="number">52</span></span><br><span class="line">query60.sql,success,<span class="number">66</span>,<span class="number">100</span></span><br><span class="line">query61.sql,success,<span class="number">48</span>,<span class="number">1</span></span><br><span class="line">query62.sql,success,<span class="number">75</span>,<span class="number">100</span></span><br><span class="line">query63.sql,success,<span class="number">49</span>,<span class="number">100</span></span><br><span class="line">query64.sql,success,<span class="number">213</span>,<span class="number">217</span></span><br><span class="line">query65.sql,success,<span class="number">98</span>,<span class="number">100</span></span><br><span class="line">query66.sql,success,<span class="number">76</span>,<span class="number">15</span></span><br><span class="line">query67.sql,success,<span class="number">183</span>,<span class="number">100</span></span><br><span class="line">query68.sql,success,<span class="number">93</span>,<span class="number">100</span></span><br><span class="line">query7.sql,success,<span class="number">68</span>,<span class="number">100</span></span><br><span class="line">query70.sql,success,<span class="number">53</span>,<span class="number">20</span></span><br><span class="line">query71.sql,success,<span class="number">68</span>,<span class="number">69886</span></span><br><span class="line">query72.sql,success,<span class="number">273</span>,<span class="number">100</span></span><br><span class="line">query74.sql,success,<span class="number">123</span>,<span class="number">100</span></span><br><span class="line">query75.sql,success,<span class="number">250</span>,<span class="number">100</span></span><br><span class="line">query76.sql,success,<span class="number">127</span>,<span class="number">100</span></span><br><span class="line">query77.sql,success,<span class="number">121</span>,<span class="number">100</span></span><br><span class="line">query78.sql,success,<span class="number">222</span>,<span class="number">100</span></span><br><span class="line">query79.sql,success,<span class="number">53</span>,<span class="number">100</span></span><br><span class="line">query8.sql,success,<span class="number">53</span>,<span class="number">9</span></span><br><span class="line">query80.sql,success,<span class="number">454</span>,<span class="number">100</span></span><br><span class="line">query81.sql,success,<span class="number">60</span>,<span class="number">100</span></span><br><span class="line">query82.sql,success,<span class="number">96</span>,<span class="number">18</span></span><br><span class="line">query83.sql,success,<span class="number">74</span>,<span class="number">100</span></span><br><span class="line">query84.sql,success,<span class="number">80</span>,<span class="number">100</span></span><br><span class="line">query85.sql,success,<span class="number">177</span>,<span class="number">54</span></span><br><span class="line">query86.sql,success,<span class="number">73</span>,<span class="number">100</span></span><br><span class="line">query87.sql,success,<span class="number">182</span>,<span class="number">1</span></span><br><span class="line">query88.sql,success,<span class="number">92</span>,<span class="number">1</span></span><br><span class="line">query89.sql,success,<span class="number">56</span>,<span class="number">100</span></span><br><span class="line">query9.sql,success,<span class="number">191</span>,<span class="number">1</span></span><br><span class="line">query90.sql,success,<span class="number">202</span>,<span class="number">1</span></span><br><span class="line">query91.sql,success,<span class="number">61</span>,<span class="number">30</span></span><br><span class="line">query92.sql,success,<span class="number">60</span>,<span class="number">1</span></span><br><span class="line">query94.sql,success,<span class="number">243</span>,<span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210802183320712-1628394960207.png" alt="image-20210802183320712"></p>
<p>100G数据耗时</p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210803161509808-1628394960208.png" alt="image-20210803161509808"></p>
<h5 id="1-2-1-3-1T-数据产生"><a href="#1-2-1-3-1T-数据产生" class="headerlink" title="1.2.1.3 1T 数据产生"></a>1.2.1.3 1T 数据产生</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br></pre></td><td class="code"><pre><span class="line">nohup: ignoring input</span><br><span class="line">ls: `oss://gzdata-test/warehouse/tmp/tpcds-generate/1000&#x27;: No such file or directory</span><br><span class="line">Generating data at scale factor 1000.</span><br><span class="line">21/08/04 13:46:06 INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = false, remoteHostTrusted = false</span><br><span class="line">21/08/04 13:46:06 INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = false, remoteHostTrusted = false</span><br><span class="line">21/08/04 13:46:06 INFO Configuration.deprecation: mapred.task.timeout is deprecated. Instead, use mapreduce.task.timeout</span><br><span class="line">21/08/04 13:46:07 INFO ossnative.OssNativeStore: Jboot log name is /var/log/bigboot/jboot-20210804-134607-28895.LOG</span><br><span class="line">21/08/04 13:46:07 INFO ossnative.OssNativeStore: Filesystem support for magic committers is enabled, write buffer size 1048576, read buffer size 1048576</span><br><span class="line">21/08/04 13:46:07 INFO client.AHSProxy: Connecting to Application History server at emr-header-1.cluster-232810/172.16.0.181:10200</span><br><span class="line">21/08/04 13:46:07 INFO common.FsStats: cmd=getFileStatus, src=oss://gzdata-test/warehouse/tmp/tpcds-generate/1000, dst=null, size=-1, parameter=null, time-in-ms=55, version=3.5.0</span><br><span class="line">21/08/04 13:46:07 INFO hdfs.DFSClient: Created token for yuanlin: HDFS_DELEGATION_TOKEN owner=yuanlin@EMR.232810.COM, renewer=yarn, realUser=, issueDate=1628055967708, maxDate=1628660767708, sequenceNumber=11352, masterKeyId=63 on ha-hdfs:emr-cluster</span><br><span class="line">21/08/04 13:46:07 INFO security.TokenCache: Got dt for hdfs://emr-cluster; Kind: HDFS_DELEGATION_TOKEN, Service: ha-hdfs:emr-cluster, Ident: (token for yuanlin: HDFS_DELEGATION_TOKEN owner=yuanlin@EMR.232810.COM, renewer=yarn, realUser=, issueDate=1628055967708, maxDate=1628660767708, sequenceNumber=11352, masterKeyId=63)</span><br><span class="line">21/08/04 13:46:07 INFO mapreduce.JobResourceUploader: Disabling Erasure Coding for path: /tmp/hadoop-yarn/staging/yuanlin/.staging/job_1627367157851_2171</span><br><span class="line">21/08/04 13:46:07 INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = false, remoteHostTrusted = false</span><br><span class="line">21/08/04 13:46:07 INFO input.FileInputFormat: Total input files to process : 1</span><br><span class="line">21/08/04 13:46:07 INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = false, remoteHostTrusted = false</span><br><span class="line">21/08/04 13:46:07 INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = false, remoteHostTrusted = false</span><br><span class="line">21/08/04 13:46:07 INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = false, remoteHostTrusted = false</span><br><span class="line">21/08/04 13:46:07 INFO mapreduce.JobSubmitter: number of splits:1000</span><br><span class="line">21/08/04 13:46:08 INFO Configuration.deprecation: io.sort.mb is deprecated. Instead, use mapreduce.task.io.sort.mb</span><br><span class="line">21/08/04 13:46:08 INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = false, remoteHostTrusted = false</span><br><span class="line">21/08/04 13:46:08 INFO mapreduce.JobSubmitter: Submitting tokens for job: job_1627367157851_2171</span><br><span class="line">21/08/04 13:46:08 INFO mapreduce.JobSubmitter: Executing with tokens: [Kind: HDFS_DELEGATION_TOKEN, Service: ha-hdfs:emr-cluster, Ident: (token for yuanlin: HDFS_DELEGATION_TOKEN owner=yuanlin@EMR.232810.COM, renewer=yarn, realUser=, issueDate=1628055967708, maxDate=1628660767708, sequenceNumber=11352, masterKeyId=63)]</span><br><span class="line">21/08/04 13:46:08 INFO conf.Configuration: resource-types.xml not found</span><br><span class="line">21/08/04 13:46:08 INFO resource.ResourceUtils: Unable to find &#x27;resource-types.xml&#x27;.</span><br><span class="line">21/08/04 13:46:08 INFO impl.TimelineClientImpl: Timeline service address: emr-header-1.cluster-232810:8188</span><br><span class="line">21/08/04 13:46:08 INFO impl.YarnClientImpl: Submitted application application_1627367157851_2171</span><br><span class="line">21/08/04 13:46:08 INFO mapreduce.Job: The url to track the job: http://emr-header-1.cluster-232810:20888/proxy/application_1627367157851_2171/</span><br><span class="line">21/08/04 13:46:08 INFO mapreduce.Job: Running job: job_1627367157851_2171</span><br><span class="line">21/08/04 13:46:16 INFO mapreduce.Job: Job job_1627367157851_2171 running in uber mode : false</span><br><span class="line">21/08/04 13:46:16 INFO mapreduce.Job:  map 0% reduce 0%</span><br><span class="line">21/08/04 13:47:41 INFO mapreduce.Job:  map 1% reduce 0%</span><br><span class="line">21/08/04 13:47:43 INFO mapreduce.Job:  map 2% reduce 0%</span><br><span class="line">21/08/04 13:47:47 INFO mapreduce.Job:  map 3% reduce 0%</span><br><span class="line">21/08/04 13:48:15 INFO mapreduce.Job:  map 4% reduce 0%</span><br><span class="line">21/08/04 13:48:17 INFO mapreduce.Job:  map 5% reduce 0%</span><br><span class="line">21/08/04 13:48:19 INFO mapreduce.Job:  map 6% reduce 0%</span><br><span class="line">21/08/04 13:48:58 INFO mapreduce.Job:  map 7% reduce 0%</span><br><span class="line">21/08/04 13:49:03 INFO mapreduce.Job:  map 8% reduce 0%</span><br><span class="line">21/08/04 13:49:05 INFO mapreduce.Job:  map 9% reduce 0%</span><br><span class="line">21/08/04 13:49:40 INFO mapreduce.Job:  map 10% reduce 0%</span><br><span class="line">21/08/04 13:49:44 INFO mapreduce.Job:  map 11% reduce 0%</span><br><span class="line">21/08/04 13:49:49 INFO mapreduce.Job:  map 12% reduce 0%</span><br><span class="line">21/08/04 13:50:14 INFO mapreduce.Job:  map 13% reduce 0%</span><br><span class="line">21/08/04 13:50:22 INFO mapreduce.Job:  map 14% reduce 0%</span><br><span class="line">21/08/04 13:50:28 INFO mapreduce.Job:  map 15% reduce 0%</span><br><span class="line">21/08/04 13:50:55 INFO mapreduce.Job:  map 16% reduce 0%</span><br><span class="line">21/08/04 13:51:35 INFO mapreduce.Job:  map 17% reduce 0%</span><br><span class="line">21/08/04 13:51:43 INFO mapreduce.Job:  map 18% reduce 0%</span><br><span class="line">21/08/04 13:51:47 INFO mapreduce.Job:  map 19% reduce 0%</span><br><span class="line">21/08/04 13:52:19 INFO mapreduce.Job:  map 20% reduce 0%</span><br><span class="line">21/08/04 13:52:35 INFO mapreduce.Job:  map 21% reduce 0%</span><br><span class="line">21/08/04 13:52:37 INFO mapreduce.Job:  map 22% reduce 0%</span><br><span class="line">21/08/04 13:52:53 INFO mapreduce.Job:  map 23% reduce 0%</span><br><span class="line">21/08/04 13:53:01 INFO mapreduce.Job:  map 24% reduce 0%</span><br><span class="line">21/08/04 13:53:08 INFO mapreduce.Job:  map 25% reduce 0%</span><br><span class="line">21/08/04 13:53:35 INFO mapreduce.Job:  map 26% reduce 0%</span><br><span class="line">21/08/04 13:53:52 INFO mapreduce.Job:  map 27% reduce 0%</span><br><span class="line">21/08/04 13:53:59 INFO mapreduce.Job:  map 28% reduce 0%</span><br><span class="line">21/08/04 13:54:12 INFO mapreduce.Job:  map 29% reduce 0%</span><br><span class="line">21/08/04 13:54:18 INFO mapreduce.Job:  map 30% reduce 0%</span><br><span class="line">21/08/04 13:54:28 INFO mapreduce.Job:  map 31% reduce 0%</span><br><span class="line">21/08/04 13:54:56 INFO mapreduce.Job:  map 32% reduce 0%</span><br><span class="line">21/08/04 13:55:09 INFO mapreduce.Job:  map 33% reduce 0%</span><br><span class="line">21/08/04 13:55:20 INFO mapreduce.Job:  map 34% reduce 0%</span><br><span class="line">21/08/04 13:55:28 INFO mapreduce.Job:  map 35% reduce 0%</span><br><span class="line">21/08/04 13:55:36 INFO mapreduce.Job:  map 36% reduce 0%</span><br><span class="line">21/08/04 13:55:46 INFO mapreduce.Job:  map 37% reduce 0%</span><br><span class="line">21/08/04 13:56:09 INFO mapreduce.Job:  map 38% reduce 0%</span><br><span class="line">21/08/04 13:56:25 INFO mapreduce.Job:  map 39% reduce 0%</span><br><span class="line">21/08/04 13:56:41 INFO mapreduce.Job:  map 40% reduce 0%</span><br><span class="line">21/08/04 13:56:46 INFO mapreduce.Job:  map 41% reduce 0%</span><br><span class="line">21/08/04 13:56:54 INFO mapreduce.Job:  map 42% reduce 0%</span><br><span class="line">21/08/04 13:57:06 INFO mapreduce.Job:  map 43% reduce 0%</span><br><span class="line">21/08/04 13:57:23 INFO mapreduce.Job:  map 44% reduce 0%</span><br><span class="line">21/08/04 13:57:44 INFO mapreduce.Job:  map 45% reduce 0%</span><br><span class="line">21/08/04 13:57:58 INFO mapreduce.Job:  map 46% reduce 0%</span><br><span class="line">21/08/04 13:58:06 INFO mapreduce.Job:  map 47% reduce 0%</span><br><span class="line">21/08/04 13:58:13 INFO mapreduce.Job:  map 48% reduce 0%</span><br><span class="line">21/08/04 13:58:37 INFO mapreduce.Job:  map 49% reduce 0%</span><br><span class="line">21/08/04 13:58:59 INFO mapreduce.Job:  map 50% reduce 0%</span><br><span class="line">21/08/04 13:59:14 INFO mapreduce.Job:  map 51% reduce 0%</span><br><span class="line">21/08/04 13:59:23 INFO mapreduce.Job:  map 52% reduce 0%</span><br><span class="line">21/08/04 13:59:31 INFO mapreduce.Job:  map 53% reduce 0%</span><br><span class="line">21/08/04 13:59:54 INFO mapreduce.Job:  map 54% reduce 0%</span><br><span class="line">21/08/04 14:00:17 INFO mapreduce.Job:  map 55% reduce 0%</span><br><span class="line">21/08/04 14:00:32 INFO mapreduce.Job:  map 56% reduce 0%</span><br><span class="line">21/08/04 14:00:37 INFO mapreduce.Job:  map 57% reduce 0%</span><br><span class="line">21/08/04 14:00:45 INFO mapreduce.Job:  map 58% reduce 0%</span><br><span class="line">21/08/04 14:00:52 INFO mapreduce.Job:  map 59% reduce 0%</span><br><span class="line">21/08/04 14:01:18 INFO mapreduce.Job:  map 60% reduce 0%</span><br><span class="line">21/08/04 14:01:36 INFO mapreduce.Job:  map 61% reduce 0%</span><br><span class="line">21/08/04 14:01:51 INFO mapreduce.Job:  map 62% reduce 0%</span><br><span class="line">21/08/04 14:01:57 INFO mapreduce.Job:  map 63% reduce 0%</span><br><span class="line">21/08/04 14:02:04 INFO mapreduce.Job:  map 64% reduce 0%</span><br><span class="line">21/08/04 14:02:12 INFO mapreduce.Job:  map 65% reduce 0%</span><br><span class="line">21/08/04 14:02:37 INFO mapreduce.Job:  map 66% reduce 0%</span><br><span class="line">21/08/04 14:02:52 INFO mapreduce.Job:  map 67% reduce 0%</span><br><span class="line">21/08/04 14:03:23 INFO mapreduce.Job:  map 68% reduce 0%</span><br><span class="line">21/08/04 14:03:37 INFO mapreduce.Job:  map 69% reduce 0%</span><br><span class="line">21/08/04 14:04:05 INFO mapreduce.Job:  map 70% reduce 0%</span><br><span class="line">21/08/04 14:04:37 INFO mapreduce.Job:  map 71% reduce 0%</span><br><span class="line">21/08/04 14:04:56 INFO mapreduce.Job:  map 72% reduce 0%</span><br><span class="line">21/08/04 14:05:17 INFO mapreduce.Job:  map 73% reduce 0%</span><br><span class="line">21/08/04 14:05:26 INFO mapreduce.Job:  map 74% reduce 0%</span><br><span class="line">21/08/04 14:05:32 INFO mapreduce.Job:  map 75% reduce 0%</span><br><span class="line">21/08/04 14:05:41 INFO mapreduce.Job:  map 76% reduce 0%</span><br><span class="line">21/08/04 14:05:53 INFO mapreduce.Job:  map 77% reduce 0%</span><br><span class="line">21/08/04 14:06:26 INFO mapreduce.Job:  map 78% reduce 0%</span><br><span class="line">21/08/04 14:06:41 INFO mapreduce.Job:  map 79% reduce 0%</span><br><span class="line">21/08/04 14:06:49 INFO mapreduce.Job:  map 80% reduce 0%</span><br><span class="line">21/08/04 14:06:56 INFO mapreduce.Job:  map 81% reduce 0%</span><br><span class="line">21/08/04 14:07:08 INFO mapreduce.Job:  map 82% reduce 0%</span><br><span class="line">21/08/04 14:07:20 INFO mapreduce.Job:  map 83% reduce 0%</span><br><span class="line">21/08/04 14:07:51 INFO mapreduce.Job:  map 84% reduce 0%</span><br><span class="line">21/08/04 14:07:59 INFO mapreduce.Job:  map 85% reduce 0%</span><br><span class="line">21/08/04 14:08:06 INFO mapreduce.Job:  map 86% reduce 0%</span><br><span class="line">21/08/04 14:08:16 INFO mapreduce.Job:  map 87% reduce 0%</span><br><span class="line">21/08/04 14:08:27 INFO mapreduce.Job:  map 88% reduce 0%</span><br><span class="line">21/08/04 14:08:43 INFO mapreduce.Job:  map 89% reduce 0%</span><br><span class="line">21/08/04 14:09:06 INFO mapreduce.Job:  map 90% reduce 0%</span><br><span class="line">21/08/04 14:09:19 INFO mapreduce.Job:  map 91% reduce 0%</span><br><span class="line">21/08/04 14:09:24 INFO mapreduce.Job:  map 92% reduce 0%</span><br><span class="line">21/08/04 14:09:33 INFO mapreduce.Job:  map 93% reduce 0%</span><br><span class="line">21/08/04 14:09:44 INFO mapreduce.Job:  map 94% reduce 0%</span><br><span class="line">21/08/04 14:10:05 INFO mapreduce.Job:  map 95% reduce 0%</span><br><span class="line">21/08/04 14:10:16 INFO mapreduce.Job:  map 96% reduce 0%</span><br><span class="line">21/08/04 14:10:37 INFO mapreduce.Job:  map 97% reduce 0%</span><br><span class="line">21/08/04 14:10:45 INFO mapreduce.Job:  map 98% reduce 0%</span><br><span class="line">21/08/04 14:10:51 INFO mapreduce.Job:  map 99% reduce 0%</span><br><span class="line">21/08/04 14:11:01 INFO mapreduce.Job:  map 100% reduce 0%</span><br><span class="line">21/08/04 14:12:04 INFO mapreduce.Job: Job job_1627367157851_2171 completed successfully</span><br><span class="line">21/08/04 14:12:04 INFO mapreduce.Job: Counters: 39</span><br><span class="line">	File System Counters</span><br><span class="line">		FILE: Number of bytes read=0</span><br><span class="line">		FILE: Number of bytes written=254330890</span><br><span class="line">		FILE: Number of read operations=0</span><br><span class="line">		FILE: Number of large read operations=0</span><br><span class="line">		FILE: Number of write operations=0</span><br><span class="line">		HDFS: Number of bytes read=3965781</span><br><span class="line">		HDFS: Number of bytes written=0</span><br><span class="line">		HDFS: Number of read operations=2000</span><br><span class="line">		HDFS: Number of large read operations=0</span><br><span class="line">		HDFS: Number of write operations=0</span><br><span class="line">		HDFS: Number of bytes read erasure-coded=0</span><br><span class="line">		OSS: Number of bytes read=11659215</span><br><span class="line">		OSS: Number of bytes written=984265624444</span><br><span class="line">		OSS: Number of read operations=0</span><br><span class="line">		OSS: Number of large read operations=0</span><br><span class="line">		OSS: Number of write operations=0</span><br><span class="line">	Job Counters </span><br><span class="line">		Killed map tasks=6</span><br><span class="line">		Launched map tasks=1003</span><br><span class="line">		Other local map tasks=1003</span><br><span class="line">		Total time spent by all maps in occupied slots (ms)=159747698</span><br><span class="line">		Total time spent by all reduces in occupied slots (ms)=0</span><br><span class="line">		Total time spent by all map tasks (ms)=79873849</span><br><span class="line">		Total vcore-milliseconds taken by all map tasks=79873849</span><br><span class="line">		Total megabyte-milliseconds taken by all map tasks=327163285504</span><br><span class="line">	Map-Reduce Framework</span><br><span class="line">		Map input records=1000</span><br><span class="line">		Map output records=0</span><br><span class="line">		Input split bytes=107000</span><br><span class="line">		Spilled Records=0</span><br><span class="line">		Failed Shuffles=0</span><br><span class="line">		Merged Map outputs=0</span><br><span class="line">		GC time elapsed (ms)=151908</span><br><span class="line">		CPU time spent (ms)=12517300</span><br><span class="line">		Physical memory (bytes) snapshot=1494538047488</span><br><span class="line">		Virtual memory (bytes) snapshot=6313293053952</span><br><span class="line">		Total committed heap usage (bytes)=1957032886272</span><br><span class="line">		Peak Map Physical memory (bytes)=1882857472</span><br><span class="line">		Peak Map Virtual memory (bytes)=6839226368</span><br><span class="line">	File Input Format Counters </span><br><span class="line">		Bytes Read=3858781</span><br><span class="line">	File Output Format Counters </span><br><span class="line">		Bytes Written=0</span><br><span class="line">TPC-DS text data generation complete.</span><br><span class="line">Loading text data into external tables.</span><br><span class="line">--set hive.enforce.bucketing=true;</span><br><span class="line">--set hive.enforce.sorting=true;</span><br><span class="line">set hive.exec.dynamic.partition.mode=nonstrict;</span><br><span class="line">set hive.exec.max.dynamic.partitions.pernode=1000000;</span><br><span class="line">set hive.exec.max.dynamic.partitions=1000000;</span><br><span class="line">set hive.exec.max.created.files=1000000;</span><br><span class="line"></span><br><span class="line">-- set mapreduce.input.fileinputformat.split.minsize=240000000;</span><br><span class="line">-- set mapreduce.input.fileinputformat.split.maxsize=240000000;</span><br><span class="line">-- set mapreduce.input.fileinputformat.split.minsize.per.node=240000000;</span><br><span class="line">-- set mapreduce.input.fileinputformat.split.minsize.per.rack=240000000;</span><br><span class="line">--set hive.exec.parallel=true;</span><br><span class="line">set hive.stats.autogather=true;</span><br><span class="line">-- set hive.support.concurrency=false;</span><br><span class="line">-- set hive.txn.manager=org.apache.hadoop.hive.ql.lockmgr.DummyTxnManager;</span><br><span class="line"></span><br><span class="line">set hive.optimize.sort.dynamic.partition.threshold=0;</span><br><span class="line">create database if not exists $&#123;DB&#125;;</span><br><span class="line">use $&#123;DB&#125;;</span><br><span class="line">-- Table&lt;store_sales (23 cols)  partition=ss_sold_date_sk&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists store_sales;</span><br><span class="line">create external table if not exists store_sales(</span><br><span class="line">ss_sold_date_sk bigint</span><br><span class="line">,     ss_sold_time_sk bigint</span><br><span class="line">,     ss_item_sk bigint</span><br><span class="line">,     ss_customer_sk bigint</span><br><span class="line">,     ss_cdemo_sk bigint</span><br><span class="line">,     ss_hdemo_sk bigint</span><br><span class="line">,     ss_addr_sk bigint</span><br><span class="line">,     ss_store_sk bigint</span><br><span class="line">,     ss_promo_sk bigint</span><br><span class="line">,     ss_ticket_number bigint</span><br><span class="line">,     ss_quantity int</span><br><span class="line">,     ss_wholesale_cost decimal(7,2)</span><br><span class="line">,     ss_list_price decimal(7,2)</span><br><span class="line">,     ss_sales_price decimal(7,2)</span><br><span class="line">,     ss_ext_discount_amt decimal(7,2)</span><br><span class="line">,     ss_ext_sales_price decimal(7,2)</span><br><span class="line">,     ss_ext_wholesale_cost decimal(7,2)</span><br><span class="line">,     ss_ext_list_price decimal(7,2)</span><br><span class="line">,     ss_ext_tax decimal(7,2)</span><br><span class="line">,     ss_coupon_amt decimal(7,2)</span><br><span class="line">,     ss_net_paid decimal(7,2)</span><br><span class="line">,     ss_net_paid_inc_tax decimal(7,2)</span><br><span class="line">,     ss_net_profit decimal(7,2)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/store_sales&#x27;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">-- Table&lt;store_returns (20 cols)  partition=sr_returned_date_sk&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists store_returns;</span><br><span class="line">create external table if not exists store_returns(</span><br><span class="line">sr_returned_date_sk bigint</span><br><span class="line">,     sr_return_time_sk bigint</span><br><span class="line">,     sr_item_sk bigint</span><br><span class="line">,     sr_customer_sk bigint</span><br><span class="line">,     sr_cdemo_sk bigint</span><br><span class="line">,     sr_hdemo_sk bigint</span><br><span class="line">,     sr_addr_sk bigint</span><br><span class="line">,     sr_store_sk bigint</span><br><span class="line">,     sr_reason_sk bigint</span><br><span class="line">,     sr_ticket_number bigint</span><br><span class="line">,     sr_return_quantity int</span><br><span class="line">,     sr_return_amt decimal(7,2)</span><br><span class="line">,     sr_return_tax decimal(7,2)</span><br><span class="line">,     sr_return_amt_inc_tax decimal(7,2)</span><br><span class="line">,     sr_fee decimal(7,2)</span><br><span class="line">,     sr_return_ship_cost decimal(7,2)</span><br><span class="line">,     sr_refunded_cash decimal(7,2)</span><br><span class="line">,     sr_reversed_charge decimal(7,2)</span><br><span class="line">,     sr_store_credit decimal(7,2)</span><br><span class="line">,     sr_net_loss decimal(7,2)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/store_returns&#x27;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">-- Table&lt;catalog_sales (34 cols)  partition=cs_sold_date_sk&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists catalog_sales;</span><br><span class="line">create external table if not exists catalog_sales(</span><br><span class="line">cs_sold_date_sk bigint</span><br><span class="line">,     cs_sold_time_sk bigint</span><br><span class="line">,     cs_ship_date_sk bigint</span><br><span class="line">,     cs_bill_customer_sk bigint</span><br><span class="line">,     cs_bill_cdemo_sk bigint</span><br><span class="line">,     cs_bill_hdemo_sk bigint</span><br><span class="line">,     cs_bill_addr_sk bigint</span><br><span class="line">,     cs_ship_customer_sk bigint</span><br><span class="line">,     cs_ship_cdemo_sk bigint</span><br><span class="line">,     cs_ship_hdemo_sk bigint</span><br><span class="line">,     cs_ship_addr_sk bigint</span><br><span class="line">,     cs_call_center_sk bigint</span><br><span class="line">,     cs_catalog_page_sk bigint</span><br><span class="line">,     cs_ship_mode_sk bigint</span><br><span class="line">,     cs_warehouse_sk bigint</span><br><span class="line">,     cs_item_sk bigint</span><br><span class="line">,     cs_promo_sk bigint</span><br><span class="line">,     cs_order_number bigint</span><br><span class="line">,     cs_quantity int</span><br><span class="line">,     cs_wholesale_cost decimal(7,2)</span><br><span class="line">,     cs_list_price decimal(7,2)</span><br><span class="line">,     cs_sales_price decimal(7,2)</span><br><span class="line">,     cs_ext_discount_amt decimal(7,2)</span><br><span class="line">,     cs_ext_sales_price decimal(7,2)</span><br><span class="line">,     cs_ext_wholesale_cost decimal(7,2)</span><br><span class="line">,     cs_ext_list_price decimal(7,2)</span><br><span class="line">,     cs_ext_tax decimal(7,2)</span><br><span class="line">,     cs_coupon_amt decimal(7,2)</span><br><span class="line">,     cs_ext_ship_cost decimal(7,2)</span><br><span class="line">,     cs_net_paid decimal(7,2)</span><br><span class="line">,     cs_net_paid_inc_tax decimal(7,2)</span><br><span class="line">,     cs_net_paid_inc_ship decimal(7,2)</span><br><span class="line">,     cs_net_paid_inc_ship_tax decimal(7,2)</span><br><span class="line">,     cs_net_profit decimal(7,2)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/catalog_sales&#x27;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">-- Table&lt;catalog_returns (27 cols)  partition=cr_returned_date_sk&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists catalog_returns;</span><br><span class="line">create external table if not exists catalog_returns(</span><br><span class="line">cr_returned_date_sk bigint</span><br><span class="line">,     cr_returned_time_sk bigint</span><br><span class="line">,     cr_item_sk bigint</span><br><span class="line">,     cr_refunded_customer_sk bigint</span><br><span class="line">,     cr_refunded_cdemo_sk bigint</span><br><span class="line">,     cr_refunded_hdemo_sk bigint</span><br><span class="line">,     cr_refunded_addr_sk bigint</span><br><span class="line">,     cr_returning_customer_sk bigint</span><br><span class="line">,     cr_returning_cdemo_sk bigint</span><br><span class="line">,     cr_returning_hdemo_sk bigint</span><br><span class="line">,     cr_returning_addr_sk bigint</span><br><span class="line">,     cr_call_center_sk bigint</span><br><span class="line">,     cr_catalog_page_sk bigint</span><br><span class="line">,     cr_ship_mode_sk bigint</span><br><span class="line">,     cr_warehouse_sk bigint</span><br><span class="line">,     cr_reason_sk bigint</span><br><span class="line">,     cr_order_number bigint</span><br><span class="line">,     cr_return_quantity int</span><br><span class="line">,     cr_return_amount decimal(7,2)</span><br><span class="line">,     cr_return_tax decimal(7,2)</span><br><span class="line">,     cr_return_amt_inc_tax decimal(7,2)</span><br><span class="line">,     cr_fee decimal(7,2)</span><br><span class="line">,     cr_return_ship_cost decimal(7,2)</span><br><span class="line">,     cr_refunded_cash decimal(7,2)</span><br><span class="line">,     cr_reversed_charge decimal(7,2)</span><br><span class="line">,     cr_store_credit decimal(7,2)</span><br><span class="line">,     cr_net_loss decimal(7,2)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/catalog_returns&#x27;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">-- Table&lt;web_sales (34 cols)  partition=ws_sold_date_sk&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists web_sales;</span><br><span class="line">create external table if not exists web_sales(</span><br><span class="line">ws_sold_date_sk bigint</span><br><span class="line">,     ws_sold_time_sk bigint</span><br><span class="line">,     ws_ship_date_sk bigint</span><br><span class="line">,     ws_item_sk bigint</span><br><span class="line">,     ws_bill_customer_sk bigint</span><br><span class="line">,     ws_bill_cdemo_sk bigint</span><br><span class="line">,     ws_bill_hdemo_sk bigint</span><br><span class="line">,     ws_bill_addr_sk bigint</span><br><span class="line">,     ws_ship_customer_sk bigint</span><br><span class="line">,     ws_ship_cdemo_sk bigint</span><br><span class="line">,     ws_ship_hdemo_sk bigint</span><br><span class="line">,     ws_ship_addr_sk bigint</span><br><span class="line">,     ws_web_page_sk bigint</span><br><span class="line">,     ws_web_site_sk bigint</span><br><span class="line">,     ws_ship_mode_sk bigint</span><br><span class="line">,     ws_warehouse_sk bigint</span><br><span class="line">,     ws_promo_sk bigint</span><br><span class="line">,     ws_order_number bigint</span><br><span class="line">,     ws_quantity int</span><br><span class="line">,     ws_wholesale_cost decimal(7,2)</span><br><span class="line">,     ws_list_price decimal(7,2)</span><br><span class="line">,     ws_sales_price decimal(7,2)</span><br><span class="line">,     ws_ext_discount_amt decimal(7,2)</span><br><span class="line">,     ws_ext_sales_price decimal(7,2)</span><br><span class="line">,     ws_ext_wholesale_cost decimal(7,2)</span><br><span class="line">,     ws_ext_list_price decimal(7,2)</span><br><span class="line">,     ws_ext_tax decimal(7,2)</span><br><span class="line">,     ws_coupon_amt decimal(7,2)</span><br><span class="line">,     ws_ext_ship_cost decimal(7,2)</span><br><span class="line">,     ws_net_paid decimal(7,2)</span><br><span class="line">,     ws_net_paid_inc_tax decimal(7,2)</span><br><span class="line">,     ws_net_paid_inc_ship decimal(7,2)</span><br><span class="line">,     ws_net_paid_inc_ship_tax decimal(7,2)</span><br><span class="line">,     ws_net_profit decimal(7,2)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/web_sales&#x27;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">-- Table&lt;web_returns (24 cols)  partition=wr_returned_date_sk&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists web_returns;</span><br><span class="line">create external table if not exists web_returns(</span><br><span class="line">wr_returned_date_sk bigint</span><br><span class="line">,     wr_returned_time_sk bigint</span><br><span class="line">,     wr_item_sk bigint</span><br><span class="line">,     wr_refunded_customer_sk bigint</span><br><span class="line">,     wr_refunded_cdemo_sk bigint</span><br><span class="line">,     wr_refunded_hdemo_sk bigint</span><br><span class="line">,     wr_refunded_addr_sk bigint</span><br><span class="line">,     wr_returning_customer_sk bigint</span><br><span class="line">,     wr_returning_cdemo_sk bigint</span><br><span class="line">,     wr_returning_hdemo_sk bigint</span><br><span class="line">,     wr_returning_addr_sk bigint</span><br><span class="line">,     wr_web_page_sk bigint</span><br><span class="line">,     wr_reason_sk bigint</span><br><span class="line">,     wr_order_number bigint</span><br><span class="line">,     wr_return_quantity int</span><br><span class="line">,     wr_return_amt decimal(7,2)</span><br><span class="line">,     wr_return_tax decimal(7,2)</span><br><span class="line">,     wr_return_amt_inc_tax decimal(7,2)</span><br><span class="line">,     wr_fee decimal(7,2)</span><br><span class="line">,     wr_return_ship_cost decimal(7,2)</span><br><span class="line">,     wr_refunded_cash decimal(7,2)</span><br><span class="line">,     wr_reversed_charge decimal(7,2)</span><br><span class="line">,     wr_account_credit decimal(7,2)</span><br><span class="line">,     wr_net_loss decimal(7,2)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/web_returns&#x27;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">-- Table&lt;inventory (4 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists inventory;</span><br><span class="line">create external table if not exists inventory(</span><br><span class="line">inv_date_sk bigint</span><br><span class="line">,     inv_item_sk bigint</span><br><span class="line">,     inv_warehouse_sk bigint</span><br><span class="line">,     inv_quantity_on_hand int</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/inventory&#x27;;</span><br><span class="line"></span><br><span class="line">-- Table&lt;store (29 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists store;</span><br><span class="line">create external table if not exists store(</span><br><span class="line">s_store_sk bigint</span><br><span class="line">,     s_store_id char(16)</span><br><span class="line">,     s_rec_start_date date</span><br><span class="line">,     s_rec_end_date date</span><br><span class="line">,     s_closed_date_sk bigint</span><br><span class="line">,     s_store_name varchar(50)</span><br><span class="line">,     s_number_employees int</span><br><span class="line">,     s_floor_space int</span><br><span class="line">,     s_hours char(20)</span><br><span class="line">,     S_manager varchar(40)</span><br><span class="line">,     S_market_id int</span><br><span class="line">,     S_geography_class varchar(100)</span><br><span class="line">,     S_market_desc varchar(100)</span><br><span class="line">,     s_market_manager varchar(40)</span><br><span class="line">,     s_division_id int</span><br><span class="line">,     s_division_name varchar(50)</span><br><span class="line">,     s_company_id int</span><br><span class="line">,     s_company_name varchar(50)</span><br><span class="line">,     s_street_number varchar(10)</span><br><span class="line">,     s_street_name varchar(60)</span><br><span class="line">,     s_street_type char(15)</span><br><span class="line">,     s_suite_number char(10)</span><br><span class="line">,     s_city varchar(60)</span><br><span class="line">,     s_county varchar(30)</span><br><span class="line">,     s_state char(2)</span><br><span class="line">,     s_zip char(10)</span><br><span class="line">,     s_country varchar(20)</span><br><span class="line">,     s_gmt_offset decimal(5,2)</span><br><span class="line">,     s_tax_percentage decimal(5,2)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/store&#x27;</span><br><span class="line">tblproperties (&#x27;serialization.null.format&#x27;=&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">-- Table&lt;call_center (31 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists call_center;</span><br><span class="line">create external table if not exists call_center(</span><br><span class="line">cc_call_center_sk bigint</span><br><span class="line">,     cc_call_center_id char(16)</span><br><span class="line">,     cc_rec_start_date date</span><br><span class="line">,     cc_rec_end_date date</span><br><span class="line">,     cc_closed_date_sk bigint</span><br><span class="line">,     cc_open_date_sk bigint</span><br><span class="line">,     cc_name varchar(50)</span><br><span class="line">,     cc_class varchar(50)</span><br><span class="line">,     cc_employees int</span><br><span class="line">,     cc_sq_ft int</span><br><span class="line">,     cc_hours char(20)</span><br><span class="line">,     cc_manager varchar(40)</span><br><span class="line">,     cc_mkt_id int</span><br><span class="line">,     cc_mkt_class char(50)</span><br><span class="line">,     cc_mkt_desc varchar(100)</span><br><span class="line">,     cc_market_manager varchar(40)</span><br><span class="line">,     cc_division int</span><br><span class="line">,     cc_division_name varchar(50)</span><br><span class="line">,     cc_company int</span><br><span class="line">,     cc_company_name char(50)</span><br><span class="line">,     cc_street_number char(10)</span><br><span class="line">,     cc_street_name varchar(60)</span><br><span class="line">,     cc_street_type char(15)</span><br><span class="line">,     cc_suite_number char(10)</span><br><span class="line">,     cc_city varchar(60)</span><br><span class="line">,     cc_county varchar(30)</span><br><span class="line">,     cc_state char(2)</span><br><span class="line">,     cc_zip char(10)</span><br><span class="line">,     cc_country varchar(20)</span><br><span class="line">,     cc_gmt_offset decimal(5,2)</span><br><span class="line">,     cc_tax_percentage decimal(5,2)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/call_center&#x27;</span><br><span class="line">tblproperties (&#x27;serialization.null.format&#x27;=&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">-- Table&lt;catalog_page (9 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists catalog_page;</span><br><span class="line">create external table if not exists catalog_page(</span><br><span class="line">cp_catalog_page_sk bigint</span><br><span class="line">,     cp_catalog_page_id char(16)</span><br><span class="line">,     cp_start_date_sk bigint</span><br><span class="line">,     cp_end_date_sk bigint</span><br><span class="line">,     cp_department varchar(50)</span><br><span class="line">,     cp_catalog_number int</span><br><span class="line">,     cp_catalog_page_number int</span><br><span class="line">,     cp_description varchar(100)</span><br><span class="line">,     cp_type varchar(100)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/catalog_page&#x27;</span><br><span class="line">tblproperties (&#x27;serialization.null.format&#x27;=&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">-- Table&lt;web_site (26 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists web_site;</span><br><span class="line">create external table if not exists web_site(</span><br><span class="line">web_site_sk bigint</span><br><span class="line">,     web_site_id char(16)</span><br><span class="line">,     web_rec_start_date date</span><br><span class="line">,     web_rec_end_date date</span><br><span class="line">,     web_name varchar(50)</span><br><span class="line">,     web_open_date_sk bigint</span><br><span class="line">,     web_close_date_sk bigint</span><br><span class="line">,     web_class varchar(50)</span><br><span class="line">,     web_manager varchar(40)</span><br><span class="line">,     web_mkt_id int</span><br><span class="line">,     web_mkt_class varchar(50)</span><br><span class="line">,     web_mkt_desc varchar(100)</span><br><span class="line">,     web_market_manager varchar(40)</span><br><span class="line">,     web_company_id int</span><br><span class="line">,     web_company_name char(50)</span><br><span class="line">,     web_street_number char(10)</span><br><span class="line">,     web_street_name varchar(60)</span><br><span class="line">,     web_street_type char(15)</span><br><span class="line">,     web_suite_number char(10)</span><br><span class="line">,     web_city varchar(60)</span><br><span class="line">,     web_county varchar(30)</span><br><span class="line">,     web_state char(2)</span><br><span class="line">,     web_zip char(10)</span><br><span class="line">,     web_country varchar(20)</span><br><span class="line">,     web_gmt_offset decimal(5,2)</span><br><span class="line">,     web_tax_percentage decimal(5,2)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/web_site&#x27;</span><br><span class="line">tblproperties (&#x27;serialization.null.format&#x27;=&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">-- Table&lt;web_page (14 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists web_page;</span><br><span class="line">create external table if not exists web_page(</span><br><span class="line">wp_web_page_sk bigint</span><br><span class="line">,     wp_web_page_id char(16)</span><br><span class="line">,     wp_rec_start_date date</span><br><span class="line">,     wp_rec_end_date date</span><br><span class="line">,     wp_creation_date_sk bigint</span><br><span class="line">,     wp_access_date_sk bigint</span><br><span class="line">,     wp_autogen_flag char(1)</span><br><span class="line">,     wp_customer_sk bigint</span><br><span class="line">,     wp_url varchar(100)</span><br><span class="line">,     wp_type char(50)</span><br><span class="line">,     wp_char_count int</span><br><span class="line">,     wp_link_count int</span><br><span class="line">,     wp_image_count int</span><br><span class="line">,     wp_max_ad_count int</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/web_page&#x27;</span><br><span class="line">tblproperties (&#x27;serialization.null.format&#x27;=&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">-- Table&lt;warehouse (14 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists warehouse;</span><br><span class="line">create external table if not exists warehouse(</span><br><span class="line">w_warehouse_sk bigint</span><br><span class="line">,     w_warehouse_id char(16)</span><br><span class="line">,     w_warehouse_name varchar(20)</span><br><span class="line">,     w_warehouse_sq_ft int</span><br><span class="line">,     w_street_number char(10)</span><br><span class="line">,     w_street_name varchar(60)</span><br><span class="line">,     w_street_type char(15)</span><br><span class="line">,     w_suite_number char(10)</span><br><span class="line">,     w_city varchar(60)</span><br><span class="line">,     w_county varchar(30)</span><br><span class="line">,     w_state char(2)</span><br><span class="line">,     w_zip char(10)</span><br><span class="line">,     w_country varchar(20)</span><br><span class="line">,     w_gmt_offset decimal(5,2)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/warehouse&#x27;</span><br><span class="line">tblproperties (&#x27;serialization.null.format&#x27;=&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">-- Table&lt;customer (18 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists customer;</span><br><span class="line">create external table if not exists customer(</span><br><span class="line">c_customer_sk bigint</span><br><span class="line">,     c_customer_id char(16)</span><br><span class="line">,     c_current_cdemo_sk bigint</span><br><span class="line">,     c_current_hdemo_sk bigint</span><br><span class="line">,     c_current_addr_sk bigint</span><br><span class="line">,     c_first_shipto_date_sk bigint</span><br><span class="line">,     c_first_sales_date_sk bigint</span><br><span class="line">,     c_salutation char(10)</span><br><span class="line">,     c_first_name char(20)</span><br><span class="line">,     c_last_name char(30)</span><br><span class="line">,     c_preferred_cust_flag char(1)</span><br><span class="line">,     c_birth_day int</span><br><span class="line">,     c_birth_month int</span><br><span class="line">,     c_birth_year int</span><br><span class="line">,     c_birth_country varchar(20)</span><br><span class="line">,     c_login char(13)</span><br><span class="line">,     c_email_address char(50)</span><br><span class="line">,     c_last_review_date_sk bigint</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/customer&#x27;</span><br><span class="line">tblproperties (&#x27;serialization.null.format&#x27;=&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">-- Table&lt;customer_address (13 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists customer_address;</span><br><span class="line">create external table if not exists customer_address(</span><br><span class="line">ca_address_sk bigint</span><br><span class="line">,     ca_address_id char(16)</span><br><span class="line">,     ca_street_number char(10)</span><br><span class="line">,     ca_street_name varchar(60)</span><br><span class="line">,     ca_street_type char(15)</span><br><span class="line">,     ca_suite_number char(10)</span><br><span class="line">,     ca_city varchar(60)</span><br><span class="line">,     ca_county varchar(30)</span><br><span class="line">,     ca_state char(2)</span><br><span class="line">,     ca_zip char(10)</span><br><span class="line">,     ca_country varchar(20)</span><br><span class="line">,     ca_gmt_offset decimal(5,2)</span><br><span class="line">,     ca_location_type char(20)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/customer_address&#x27;</span><br><span class="line">tblproperties (&#x27;serialization.null.format&#x27;=&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">-- Table&lt;customer_demographics (9 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists customer_demographics;</span><br><span class="line">create external table if not exists customer_demographics(</span><br><span class="line">cd_demo_sk bigint</span><br><span class="line">,     cd_gender char(1)</span><br><span class="line">,     cd_marital_status char(1)</span><br><span class="line">,     cd_education_status char(20)</span><br><span class="line">,     cd_purchase_estimate int</span><br><span class="line">,     cd_credit_rating char(10)</span><br><span class="line">,     cd_dep_count int</span><br><span class="line">,     cd_dep_employed_count int</span><br><span class="line">,     cd_dep_college_count int</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/customer_demographics&#x27;</span><br><span class="line">tblproperties (&#x27;serialization.null.format&#x27;=&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">-- Table&lt;date_dim (28 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists date_dim;</span><br><span class="line">create external table if not exists date_dim(</span><br><span class="line">d_date_sk bigint</span><br><span class="line">,     d_date_id char(16)</span><br><span class="line">,     d_date date</span><br><span class="line">,     d_month_seq int</span><br><span class="line">,     d_week_seq int</span><br><span class="line">,     d_quarter_seq int</span><br><span class="line">,     d_year int</span><br><span class="line">,     d_dow int</span><br><span class="line">,     d_moy int</span><br><span class="line">,     d_dom int</span><br><span class="line">,     d_qoy int</span><br><span class="line">,     d_fy_year int</span><br><span class="line">,     d_fy_quarter_seq int</span><br><span class="line">,     d_fy_week_seq int</span><br><span class="line">,     d_day_name char(9)</span><br><span class="line">,     d_quarter_name char(6)</span><br><span class="line">,     d_holiday char(1)</span><br><span class="line">,     d_weekend char(1)</span><br><span class="line">,     d_following_holiday char(1)</span><br><span class="line">,     d_first_dom int</span><br><span class="line">,     d_last_dom int</span><br><span class="line">,     d_same_day_ly int</span><br><span class="line">,     d_same_day_lq int</span><br><span class="line">,     d_current_day char(1)</span><br><span class="line">,     d_current_week char(1)</span><br><span class="line">,     d_current_month char(1)</span><br><span class="line">,     d_current_quarter char(1)</span><br><span class="line">,     d_current_year char(1)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/date_dim&#x27;</span><br><span class="line">tblproperties (&#x27;serialization.null.format&#x27;=&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">-- Table&lt;household_demographics (5 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists household_demographics;</span><br><span class="line">create external table if not exists household_demographics(</span><br><span class="line">hd_demo_sk bigint</span><br><span class="line">,     hd_income_band_sk bigint</span><br><span class="line">,     hd_buy_potential char(15)</span><br><span class="line">,     hd_dep_count int</span><br><span class="line">,     hd_vehicle_count int</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/household_demographics&#x27;</span><br><span class="line">tblproperties (&#x27;serialization.null.format&#x27;=&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">-- Table&lt;item (22 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists item;</span><br><span class="line">create external table if not exists item(</span><br><span class="line">i_item_sk bigint</span><br><span class="line">,     i_item_id char(16)</span><br><span class="line">,     i_rec_start_date date</span><br><span class="line">,     i_rec_end_date date</span><br><span class="line">,     i_item_desc varchar(200)</span><br><span class="line">,     i_current_price decimal(7,2)</span><br><span class="line">,     i_wholesale_cost decimal(7,2)</span><br><span class="line">,     i_brand_id int</span><br><span class="line">,     i_brand char(50)</span><br><span class="line">,     i_class_id int</span><br><span class="line">,     i_class char(50)</span><br><span class="line">,     i_category_id int</span><br><span class="line">,     i_category char(50)</span><br><span class="line">,     i_manufact_id int</span><br><span class="line">,     i_manufact char(50)</span><br><span class="line">,     i_size char(20)</span><br><span class="line">,     i_formulation char(20)</span><br><span class="line">,     i_color char(20)</span><br><span class="line">,     i_units char(10)</span><br><span class="line">,     i_container char(10)</span><br><span class="line">,     i_manager_id int</span><br><span class="line">,     i_product_name char(50)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/item&#x27;</span><br><span class="line">tblproperties (&#x27;serialization.null.format&#x27;=&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">-- Table&lt;income_band (3 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists income_band;</span><br><span class="line">create external table if not exists income_band(</span><br><span class="line">ib_income_band_sk bigint</span><br><span class="line">,     ib_lower_bound int</span><br><span class="line">,     ib_upper_bound int</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/income_band&#x27;;</span><br><span class="line"></span><br><span class="line">-- Table&lt;promotion (19 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists promotion;</span><br><span class="line">create external table if not exists promotion(</span><br><span class="line">p_promo_sk bigint</span><br><span class="line">,     p_promo_id char(16)</span><br><span class="line">,     p_start_date_sk bigint</span><br><span class="line">,     p_end_date_sk bigint</span><br><span class="line">,     p_item_sk bigint</span><br><span class="line">,     p_cost decimal(15,2)</span><br><span class="line">,     p_response_target int</span><br><span class="line">,     p_promo_name char(50)</span><br><span class="line">,     p_channel_dmail char(1)</span><br><span class="line">,     p_channel_email char(1)</span><br><span class="line">,     p_channel_catalog char(1)</span><br><span class="line">,     p_channel_tv char(1)</span><br><span class="line">,     p_channel_radio char(1)</span><br><span class="line">,     p_channel_press char(1)</span><br><span class="line">,     p_channel_event char(1)</span><br><span class="line">,     p_channel_demo char(1)</span><br><span class="line">,     p_channel_details varchar(100)</span><br><span class="line">,     p_purpose char(15)</span><br><span class="line">,     p_discount_active char(1)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/promotion&#x27;</span><br><span class="line">tblproperties (&#x27;serialization.null.format&#x27;=&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">-- Table&lt;reason (3 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists reason;</span><br><span class="line">create external table if not exists reason(</span><br><span class="line">r_reason_sk bigint</span><br><span class="line">,     r_reason_id char(16)</span><br><span class="line">,     r_reason_desc char(100)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/reason&#x27;</span><br><span class="line">tblproperties (&#x27;serialization.null.format&#x27;=&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">-- Table&lt;ship_mode (6 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists ship_mode;</span><br><span class="line">create external table if not exists ship_mode(</span><br><span class="line">sm_ship_mode_sk bigint</span><br><span class="line">,     sm_ship_mode_id char(16)</span><br><span class="line">,     sm_type char(30)</span><br><span class="line">,     sm_code char(10)</span><br><span class="line">,     sm_carrier char(20)</span><br><span class="line">,     sm_contract char(20)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/ship_mode&#x27;</span><br><span class="line">tblproperties (&#x27;serialization.null.format&#x27;=&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">-- Table&lt;time_dim (10 cols)&gt;</span><br><span class="line"></span><br><span class="line">drop table if exists time_dim;</span><br><span class="line">create external table if not exists time_dim(</span><br><span class="line">t_time_sk bigint</span><br><span class="line">,     t_time_id char(16)</span><br><span class="line">,     t_time int</span><br><span class="line">,     t_hour int</span><br><span class="line">,     t_minute int</span><br><span class="line">,     t_second int</span><br><span class="line">,     t_am_pm char(2)</span><br><span class="line">,     t_shift char(20)</span><br><span class="line">,     t_sub_shift char(20)</span><br><span class="line">,     t_meal_time char(20)</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;|&#x27;</span><br><span class="line">location &#x27;$&#123;LOCATION&#125;/time_dim&#x27;</span><br><span class="line">tblproperties (&#x27;serialization.null.format&#x27;=&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Optimizing table date_dim (1/24).</span><br><span class="line">Optimizing table time_dim (2/24).</span><br><span class="line">Optimizing table item (3/24).</span><br><span class="line">Optimizing table customer (4/24).</span><br><span class="line">Optimizing table customer_demographics (5/24).</span><br><span class="line">Optimizing table household_demographics (6/24).</span><br><span class="line">Optimizing table customer_address (7/24).</span><br><span class="line">Optimizing table store (8/24).</span><br><span class="line">Optimizing table promotion (9/24).</span><br><span class="line">Optimizing table warehouse (10/24).</span><br><span class="line">Optimizing table ship_mode (11/24).</span><br><span class="line">Optimizing table reason (12/24).</span><br><span class="line">Optimizing table income_band (13/24).</span><br><span class="line">Optimizing table call_center (14/24).</span><br><span class="line">Optimizing table web_page (15/24).</span><br><span class="line">Optimizing table catalog_page (16/24).</span><br><span class="line">Optimizing table web_site (17/24).</span><br><span class="line">Optimizing table store_sales (18/24).</span><br><span class="line">Optimizing table store_returns (19/24).</span><br><span class="line">Optimizing table web_sales (20/24).</span><br><span class="line">Optimizing table web_returns (21/24).</span><br><span class="line">Optimizing table catalog_sales (22/24).</span><br><span class="line">Optimizing table catalog_returns (23/24).</span><br><span class="line">Optimizing table inventory (24/24).</span><br><span class="line">Loading constraints</span><br><span class="line">-- set hivevar:DB=tpcds_bin_partitioned_orc_10000</span><br><span class="line"></span><br><span class="line">alter table customer_address add constraint $&#123;DB&#125;_pk_ca primary key (ca_address_sk) disable novalidate rely;</span><br><span class="line">Data loaded into database tpcds_bin_partitioned_orc_1000.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>1.5.4 1T 数据查询</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">filename,status,time,rows</span><br><span class="line">query1.sql,success,73,100</span><br><span class="line">query10.sql,success,92,100</span><br><span class="line">query11.sql,success,574,100</span><br><span class="line">query12.sql,success,44,100</span><br><span class="line">query13.sql,success,88,1</span><br><span class="line">query14.sql,success,874,100</span><br><span class="line">query15.sql,success,62,100</span><br><span class="line">query16.sql,success,257,1</span><br><span class="line">query17.sql,success,145,100</span><br><span class="line">query18.sql,success,93,100</span><br><span class="line">query19.sql,success,54,100</span><br><span class="line">query2.sql,success,196,2513</span><br><span class="line">query20.sql,success,41,100</span><br><span class="line">query21.sql,success,52,100</span><br><span class="line">query22.sql,success,294,100</span><br><span class="line">query23.sql,success,1760,1</span><br><span class="line">query23.sql,success,1760,100</span><br><span class="line">query24.sql,success,678,536</span><br><span class="line">query24.sql,success,678,76</span><br><span class="line">query25.sql,success,118,100</span><br><span class="line">query26.sql,success,59,100</span><br><span class="line">query27.sql,success,76,100</span><br><span class="line">query28.sql,success,141,1</span><br><span class="line">query29.sql,success,225,100</span><br><span class="line">query3.sql,success,50,100</span><br><span class="line">query30.sql,success,78,100</span><br><span class="line">query31.sql,success,122,272</span><br><span class="line">query32.sql,success,45,1</span><br><span class="line">query33.sql,success,73,100</span><br><span class="line">query34.sql,success,64,13713</span><br><span class="line">query35.sql,success,108,100</span><br><span class="line">query36.sql,success,82,100</span><br><span class="line">query37.sql,success,102,5</span><br><span class="line">query38.sql,success,297,1</span><br><span class="line">query39.sql,success,88,10015</span><br><span class="line">query39.sql,success,88,368</span><br><span class="line">query4.sql,success,995,100</span><br><span class="line">query40.sql,success,122,100</span><br><span class="line">query41.sql,success,31,100</span><br><span class="line">query42.sql,success,43,12</span><br><span class="line">query43.sql,success,56,100</span><br><span class="line">query45.sql,success,63,100</span><br><span class="line">query46.sql,success,77,100</span><br><span class="line">query47.sql,success,112,100</span><br><span class="line">query48.sql,success,73,1</span><br><span class="line">query49.sql,success,194,100</span><br><span class="line">query5.sql,success,270,100</span><br><span class="line">query50.sql,success,1668,100</span><br><span class="line">query51.sql,success,172,100</span><br><span class="line">query52.sql,success,41,100</span><br><span class="line">query53.sql,success,60,100</span><br><span class="line">query54.sql,success,413,100</span><br><span class="line">query55.sql,success,42,100</span><br><span class="line">query56.sql,success,70,100</span><br><span class="line">query57.sql,success,83,100</span><br><span class="line">query58.sql,success,67,100</span><br><span class="line">query59.sql,success,145,100</span><br><span class="line">query6.sql,success,67,52</span><br><span class="line">query60.sql,success,73,100</span><br><span class="line">query61.sql,success,55,1</span><br><span class="line">query62.sql,success,99,100</span><br><span class="line">query63.sql,success,57,100</span><br><span class="line">query64.sql,failed,321</span><br><span class="line">query65.sql,success,220,100</span><br><span class="line">query66.sql,success,86,20</span><br><span class="line">query67.sql,success,1174,100</span><br><span class="line">query68.sql,success,65,100</span><br><span class="line">query7.sql,success,74,100</span><br><span class="line">query70.sql,success,534,52</span><br><span class="line">query71.sql,success,72,296051</span><br><span class="line">query72.sql,success,623,100</span><br><span class="line">query73.sql,success,51,386</span><br><span class="line">query74.sql,success,407,100</span><br><span class="line">query75.sql,success,439,18</span><br><span class="line">query76.sql,success,201,100</span><br><span class="line">query77.sql,success,110,100</span><br><span class="line">query78.sql,success,684,100</span><br><span class="line">query79.sql,success,66,100</span><br><span class="line">query8.sql,success,51,10</span><br><span class="line">query80.sql,success,277,100</span><br><span class="line">query81.sql,success,73,100</span><br><span class="line">query82.sql,success,129,21</span><br><span class="line">query83.sql,success,68,100</span><br><span class="line">query84.sql,success,113,100</span><br><span class="line">query85.sql,success,100,64</span><br><span class="line">query86.sql,success,53,100</span><br><span class="line">query87.sql,success,302,1</span><br><span class="line">query88.sql,success,152,1</span><br><span class="line">query89.sql,success,63,100</span><br><span class="line">query9.sql,success,164,1</span><br><span class="line">query90.sql,success,84,1</span><br><span class="line">query91.sql,success,46,42</span><br><span class="line">query92.sql,success,45,1</span><br><span class="line">query94.sql,success,197,1</span><br><span class="line">query95.sql,success,748,1</span><br><span class="line">query96.sql,success,118,1</span><br><span class="line">query97.sql,success,206,1</span><br><span class="line">query98.sql,success,42,44751</span><br><span class="line">query99.sql,success,100,100</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="1-2-1-4-系统监控"><a href="#1-2-1-4-系统监控" class="headerlink" title="1.2.1.4 系统监控"></a>1.2.1.4 系统监控</h5><h6 id="1-2-1-4-1-emr-header-1"><a href="#1-2-1-4-1-emr-header-1" class="headerlink" title="1.2.1.4.1 emr-header-1"></a>1.2.1.4.1 emr-header-1</h6><p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210805120041348-1628394960208.png" alt="image-20210805120041348"></p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210805120057688-1628394960208.png" alt="image-20210805120057688"></p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210805120115940-1628394960208.png" alt="image-20210805120115940"></p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210805115859023-1628394960208.png" alt="image-20210805115859023"></p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210805141735000-1628394960208.png" alt="image-20210805141735000"></p>
<h6 id="1-2-1-4-2-emr-worker-7"><a href="#1-2-1-4-2-emr-worker-7" class="headerlink" title="1.2.1.4.2 emr-worker-7"></a>1.2.1.4.2 emr-worker-7</h6><p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210805112924534-1628394960208.png" alt="image-20210805112924534"></p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210805112943139-1628394960208.png" alt="image-20210805112943139"></p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210805112959007-1628394960208.png" alt="image-20210805112959007"></p>
<h6 id="1-2-1-4-3-emr-worker-3"><a href="#1-2-1-4-3-emr-worker-3" class="headerlink" title="1.2.1.4.3 emr-worker-3"></a>1.2.1.4.3 emr-worker-3</h6><p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210805113121553-1628394960208.png" alt="image-20210805113121553"></p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210805113136008-1628394960208.png" alt="image-20210805113136008"></p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210805113149817-1628394960209.png" alt="image-20210805113149817"></p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210805113204504.png" alt="image-20210805113204504"></p>
<h4 id="1-2-2-Hibench"><a href="#1-2-2-Hibench" class="headerlink" title="1.2.2 Hibench"></a>1.2.2 Hibench</h4><h5 id="1-2-2-1-hibench-report"><a href="#1-2-2-1-hibench-report" class="headerlink" title="1.2.2.1 hibench.report"></a>1.2.2.1 hibench.report</h5><table>
<thead>
<tr>
<th>Type</th>
<th>Date</th>
<th>Time</th>
<th>Input_data_size</th>
<th>Duration(s)</th>
<th>Throughput(bytes/s)</th>
<th>Throughput/node</th>
</tr>
</thead>
<tbody><tr>
<td>HadoopWordcount</td>
<td>2021/8/8</td>
<td>1:42:55</td>
<td>1629154830231</td>
<td>3836</td>
<td>424651873</td>
<td>84930374</td>
</tr>
<tr>
<td>ScalaSparkWordcount</td>
<td>2021/8/8</td>
<td>3:30:22</td>
<td>1629154830231</td>
<td>6443</td>
<td>252851578</td>
<td>50570315</td>
</tr>
<tr>
<td>ScalaRepartition</td>
<td>2021/8/8</td>
<td>4:21:08</td>
<td>600000006864</td>
<td>2564</td>
<td>234037294</td>
<td>46807458</td>
</tr>
<tr>
<td>HadoopJoin</td>
<td>2021/8/8</td>
<td>4:50:50</td>
<td>930219281861</td>
<td>0</td>
<td>26577693767457</td>
<td>5315538753491</td>
</tr>
<tr>
<td>ScalaSparkJoin</td>
<td>2021/8/8</td>
<td>6:05:25</td>
<td>930219281861</td>
<td>4474</td>
<td>207930588</td>
<td>41586117</td>
</tr>
<tr>
<td>HadoopScan</td>
<td>2021/8/8</td>
<td>6:16:58</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>ScalaSparkScan</td>
<td>2021/8/8</td>
<td>6:59:55</td>
<td>398232860066</td>
<td>2570</td>
<td>154966660</td>
<td>30993332</td>
</tr>
</tbody></table>
<h5 id="1-2-2-2-hibench-服务监控"><a href="#1-2-2-2-hibench-服务监控" class="headerlink" title="1.2.2.2 hibench 服务监控"></a>1.2.2.2 hibench 服务监控</h5><p>header节点</p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210808113200481.png" alt="image-20210808113200481"></p>
<p>worker节点</p>
<p>worker2</p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210808113417212.png" alt="image-20210808113417212"></p>
<p>worker4</p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210808113537928.png" alt="image-20210808113537928"></p>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/knowledge_detail/108639.html?spm=5176.21213303.J_6028563670.7.4eb43edaNAQr5Q&amp;scm=20140722.S_help@@%E7%9F%A5%E8%AF%86%E7%82%B9@@108639.S_0.ID_108639-RL_10000%E6%9D%A1-OR_s+helpproduct-V_1-P0_0">https://help.aliyun.com/knowledge_detail/108639.html?spm=5176.21213303.J_6028563670.7.4eb43edaNAQr5Q&amp;scm=20140722.S_help%40%40%E7%9F%A5%E8%AF%86%E7%82%B9%40%40108639.S_0.ID_108639-RL_10000%E6%9D%A1-OR_s%2Bhelpproduct-V_1-P0_0</a></p>
<h3 id="1-3-实际情况"><a href="#1-3-实际情况" class="headerlink" title="1.3 实际情况"></a>1.3 实际情况</h3><p>具体作业内容：</p>
<p><a target="_blank" rel="noopener" href="https://shimo.im/sheets/vVqRVb7bLetZMbqy/MODOC">https://shimo.im/sheets/vVqRVb7bLetZMbqy/MODOC</a></p>
<h4 id="1-3-1-ORS作业运行情况"><a href="#1-3-1-ORS作业运行情况" class="headerlink" title="1.3.1 ORS作业运行情况"></a>1.3.1 ORS作业运行情况</h4><table>
<thead>
<tr>
<th>作业名称</th>
<th>作业所需CPU</th>
<th>作业所需内存</th>
<th>作业调度时间</th>
<th>运行所需时间</th>
</tr>
</thead>
<tbody><tr>
<td>com.gozen.core.Advertising$:171</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>tv.common.ors.reportminute.day.LiveAndVodByDay</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>tv.common.ors.reportminute.issue3.TempLate</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>com.gozen.core.AdLive$:174</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>tv.common.ors.reportminute.test.LiveAndVodByMinute_02</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="1-4-1-PG作业运行情况"><a href="#1-4-1-PG作业运行情况" class="headerlink" title="1.4.1 PG作业运行情况"></a>1.4.1 PG作业运行情况</h4><table>
<thead>
<tr>
<th>作业名称</th>
<th>作业所需CPU</th>
<th>作业所需内存</th>
<th>作业调度时间</th>
<th>运行所需时间</th>
</tr>
</thead>
<tbody><tr>
<td>tv.gz.bj.common.BjHimData</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>tv.gz.bj.analyse.WeekOfMonth</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>tv.gz.bj.common.BjMobileData</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>tv.gz.bj.common.BjHimData</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>tv.gz.bj.common.BjOaidData</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>tv.gz.bj.common.BjIfaData</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>tv.gz.bj.common.BjAimData</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>tv.gz.bj.common.BjBdidData</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>tv.gz.bj.common.BjAiidData</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="2-spark集群资源"><a href="#2-spark集群资源" class="headerlink" title="2. spark集群资源"></a>2. spark集群资源</h2><h3 id="2-1-现有资源"><a href="#2-1-现有资源" class="headerlink" title="2.1 现有资源"></a>2.1 现有资源</h3><table>
<thead>
  <tr>
    <th>主机名</th>
    <th colspan="4" align="center">资源配置</th>
    <th colspan="4" align="center">组件</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td></td>
    <td>CPU</td>
    <td>内存</td>
    <td>系统盘</td>
    <td>数据盘</td>
    <td>HDFS</td>
    <td>YARN</td>
    <td>HIVE</td>
    <td>SPARK</td>
  </tr>
  <tr>
    <td>emr-header-1</td>
    <td> 8</td>
    <td>32G</td>
    <td>120G</td>
    <td>80G</td>
    <td>NameNode(active)</td>
    <td>ResourceManager(active)</td>
    <td>HiveServer2</td>
    <td>Thrift Server</td>
  </tr>
  <tr>
    <td>emr-header-2</td>
    <td>4</td>
    <td>16G</td>
    <td>120G</td>
    <td>80G</td>
    <td>NameNode(standby)</td>
    <td>ResourceManager(standby)</td>
    <td>HiveServer2 </td>
    <td>Spark Client</td>
  </tr>
  <tr>
    <td>emr-header-3</td>
    <td>4</td>
    <td>16G</td>
    <td>120G</td>
    <td>80G</td>
    <td>JournalNode</td>
    <td>YARN Client</td>
    <td>Hive Client</td>
    <td>Spark Client</td>
  </tr>
  <tr>
    <td>emr-worker-1</td>
    <td>32</td>
    <td>128</td>
    <td>120G</td>
    <td>100G*4</td>
    <td>DataNode</td>
    <td>NodeManager/YARN Client</td>
    <td>Hive Client</td>
    <td>Spark Client</td>
  </tr>
  <tr>
    <td>emr-worker-2</td>
    <td>32</td>
    <td>128</td>
    <td>120G</td>
    <td>100G*4</td>
    <td>DataNode</td>
    <td>NodeManager/YARN Client</td>
    <td>Hive Client</td>
    <td>Spark Client</td>
  </tr>
  <tr>
    <td>emr-worker-3</td>
    <td>32</td>
    <td>128</td>
    <td>120G</td>
    <td>100G*4</td>
    <td>DataNode</td>
    <td>NodeManager/YARN Client</td>
    <td>Hive Client</td>
    <td>Spark Client</td>
  </tr>
  <tr>
    <td>emr-worker-4</td>
    <td>32</td>
    <td>128</td>
    <td>120G</td>
    <td>100G*4</td>
    <td>DataNode</td>
    <td>NodeManager/YARN Client</td>
    <td>Hive Client</td>
    <td>Spark Client</td>
  </tr>
  <tr>
    <td>emr-worker-7</td>
    <td>32</td>
    <td>128</td>
    <td>120G</td>
    <td>100G*4</td>
    <td>DataNode</td>
    <td>NodeManager/YARN Client</td>
    <td>Hive Client</td>
    <td>Spark Client</td>
  </tr>
</tbody>
</table>

<h3 id="2-1-1-资源分配解析"><a href="#2-1-1-资源分配解析" class="headerlink" title="2.1.1 资源分配解析"></a>2.1.1 资源分配解析</h3><p>计算任务资源：CPU ：32<code>*</code>5 = 160  内存：128<code>*</code>5 =640G </p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210807113629265.png" alt="image-20210807113629265"></p>
<p>根据当前yarn配置，虚拟核数为64核</p>
<p>每个任务最大可用核数为</p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210807113858127.png" alt="image-20210807113858127"></p>
<p>因此在资源分配时，会产生</p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\image-20210807113938533.png" alt="image-20210807113938533"></p>
<p>用户在申请资源时，指定executor num 和 executor cores ，executor memory，系统根据你申请的资源，以及申请资源的数量启动container</p>
<h2 id="2-2-改进资源"><a href="#2-2-改进资源" class="headerlink" title="2.2 改进资源"></a>2.2 改进资源</h2><table>
<thead>
  <tr>
    <th>主机名</th>
    <th colspan="4"  align="center">资源配置</th>
    <th colspan="4"  align="center">组件</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td></td>
    <td>CPU</td>
    <td>内存</td>
    <td>系统盘</td>
    <td>数据盘</td>
    <td>HDFS</td>
    <td>YARN</td>
    <td>HIVE</td>
    <td>SPARK</td>
  </tr>
  <tr>
    <td>emr-header-1</td>
    <td> 8</td>
    <td>32G</td>
    <td>120G</td>
    <td>80G</td>
    <td>NameNode(active)</td>
    <td>ResourceManager(active)</td>
    <td>HiveServer2</td>
    <td>Thrift Server</td>
  </tr>
  <tr>
    <td>emr-header-2</td>
    <td>8</td>
    <td>32G</td>
    <td>120G</td>
    <td>80G</td>
    <td>NameNode(standby)</td>
    <td>ResourceManager(standby)</td>
    <td>HiveServer2</td>
    <td>Spark Client</td>
  </tr>
  <tr>
    <td>emr-header-3</td>
    <td>8</td>
    <td>32G</td>
    <td>120G</td>
    <td>80G</td>
    <td>JournalNode</td>
    <td>YARN Client</td>
    <td>Hive Client</td>
    <td>Spark Client</td>
  </tr>
  <tr>
    <td>emr-worker-1</td>
    <td>52</td>
    <td>192G</td>
    <td>120G</td>
    <td>100G*4</td>
    <td>DataNode</td>
    <td>NodeManager/YARN Client</td>
    <td>Hive Client</td>
    <td>Spark Client</td>
  </tr>
  <tr>
    <td>emr-worker-2</td>
    <td>52</td>
    <td>192G</td>
    <td>120G</td>
    <td>100G*4</td>
    <td>DataNode</td>
    <td>NodeManager/YARN Client</td>
    <td>Hive Client</td>
    <td>Spark Client</td>
  </tr>
  <tr>
    <td>emr-worker-3</td>
    <td>52</td>
    <td>192G</td>
    <td>120G</td>
    <td>100G*4</td>
    <td>DataNode</td>
    <td>NodeManager/YARN Client</td>
    <td>Hive Client</td>
    <td>Spark Client</td>
  </tr>
  <tr>
    <td>emr-worker-4</td>
    <td>52</td>
    <td>192G</td>
    <td>120G</td>
    <td>100G*4</td>
    <td>DataNode</td>
    <td>NodeManager/YARN Client</td>
    <td>Hive Client</td>
    <td>Spark Client</td>
  </tr>
  <tr>
    <td>emr-worker-7</td>
    <td>52</td>
    <td>192G</td>
    <td>120G</td>
    <td>100G*4</td>
    <td>DataNode</td>
    <td>NodeManager/YARN Client</td>
    <td>Hive Client</td>
    <td>Spark Client</td>
  </tr>
</tbody>
</table>



<h4 id="2-2-1-资源分配解析"><a href="#2-2-1-资源分配解析" class="headerlink" title="2.2.1 资源分配解析"></a>2.2.1 资源分配解析</h4><p>更新为虚拟核数和物理核数1：0.8，保留服务器用于其他服务的能力，并且任务不会将container打挂</p>
<h2 id="3-spark源码解析"><a href="#3-spark源码解析" class="headerlink" title="3. spark源码解析"></a>3. spark源码解析</h2><p><img src="D:\blog\blog\source_posts\typora-user-images\spark_architecture-iteblog.png"></p>
<h3 id="3-1-spark-submit-源码"><a href="#3-1-spark-submit-源码" class="headerlink" title="3.1 spark submit 源码"></a>3.1 spark submit 源码</h3><p><img src="D:\blog\blog\source_posts\typora-user-images\20170712134317873.png" alt="这里写图片描述"></p>
<h3 id="3-2-spark-sql-源码"><a href="#3-2-spark-sql-源码" class="headerlink" title="3.2 spark sql 源码"></a>3.2 spark sql 源码</h3><p><img src="D:\blog\blog\source_posts\typora-user-images\spark_catalyst-iteblog.jpg" alt="一条SQL在Spark之旅"></p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\20200911083644648.png" alt="在这里插入图片描述"></p>
<p>其中蓝色部分就是 Catalyst 优化器处理的部分，也是本文重点介绍的部分。下面我们以一条简单的 SQL 为例，从 High-level 角度介绍 一条 SQL 在 Spark 之旅。本文我们用到的 SQL 查询语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">sum</span>(v)</span><br><span class="line">    <span class="keyword">FROM</span> (</span><br><span class="line">      <span class="keyword">SELECT</span></span><br><span class="line">        t1.id,</span><br><span class="line">    <span class="number">1</span> <span class="operator">+</span> <span class="number">2</span> <span class="operator">+</span> t1.value <span class="keyword">AS</span> v</span><br><span class="line">    <span class="keyword">FROM</span> t1 <span class="keyword">JOIN</span> t2</span><br><span class="line">      <span class="keyword">WHERE</span></span><br><span class="line">    t1.id <span class="operator">=</span> t2.id <span class="keyword">AND</span></span><br><span class="line">    t1.cid <span class="operator">=</span> <span class="number">1</span> <span class="keyword">AND</span></span><br><span class="line">    t1.did <span class="operator">=</span> t1.cid <span class="operator">+</span> <span class="number">1</span> <span class="keyword">AND</span></span><br><span class="line">      t2.id <span class="operator">&gt;</span> <span class="number">5</span>) iteblog</span><br></pre></td></tr></table></figure>

<h4 id="3-2-1-SQL-解析阶段-SqlParser"><a href="#3-2-1-SQL-解析阶段-SqlParser" class="headerlink" title="3.2.1 SQL 解析阶段 - SqlParser"></a>3.2.1 SQL 解析阶段 - SqlParser</h4><p>为了能够在 Spark 中运行 SQL 查询，第一步肯定是需要解析这条 SQL。在 Spark 1.x 版本中，SQL 的解析有两种方法：</p>
<ul>
<li>基于 Scala parser combinator 实现</li>
<li>基于 Hive 的 SQL 解析</li>
</ul>
<p>可以通过 <code>spark.sql.dialect</code> 来设置。虽然 SQL 的解析引擎可以选择，但是这种方案有以下几个问题：Scala parser combinator 解析器有时候会给出错误信息，而且在定义语法中存在冲突不会发出警告；而 Hive SQL 解析引擎依赖于 Hive，这导致扩展性不好。</p>
<p>为了解决这个问题，从 Spark 2.0.0 版本开始引入了第三方语法解析器工具 ANTLR（详情参见 <a target="_blank" rel="noopener" href="https://www.iteblog.com/redirect.php?url=aHR0cHM6Ly9pc3N1ZXMuYXBhY2hlLm9yZy9qaXJhL2Jyb3dzZS9TUEFSSy0xMjM2Mg==&article=true">SPARK-12362</a>），Antlr 是一款强大的语法生成器工具，可用于读取、处理、执行和翻译结构化的文本或二进制文件，是当前 Java 语言中使用最为广泛的语法生成器工具，我们常见的大数据 SQL 解析都用到了这个工具，包括 Hive、Cassandra、Phoenix、Pig 以及 presto 等。目前最新版本的 Spark 使用的是 ANTLR4，通过这个对 SQL 进行词法分析并构建语法树。</p>
<p>具体的，Spark 基于 presto 的语法文件定义了 Spark SQL 语法文件 SqlBase.g4（路径 spark-2.4.3\sql\catalyst\src\main\antlr4\org\apache\spark\sql\catalyst\parser\SqlBase.g4），这个文件定义了 Spark SQL 支持的 SQL 语法。如果我们需要自定义新的语法，需要在这个文件定义好相关语法。然后使用 ANTLR4 对 SqlBase.g4 文件自动解析生成几个 Java 类，其中就包含重要的<strong>词法分析器</strong> SqlBaseLexer.java 和<strong>语法分析器</strong>SqlBaseParser.java。运行上面的 SQL 会使用 SqlBaseLexer 来解析关键词以及各种标识符等；然后使用 SqlBaseParser 来构建语法树。整个过程就类似于下图。</p>
<p><a target="_blank" rel="noopener" href="https://www.iteblog.com/pic/spark/antlr4_iteblog.jpg"><img src="D:\blog\blog\source_posts\typora-user-images\antlr4_iteblog-1628309565701.jpg" alt="一条SQL在Spark之旅"></a><br>如果想及时了解Spark、Hadoop或者HBase相关的文章，欢迎关注微信公众号：<strong>iteblog_hadoop</strong></p>
<p>生成语法树之后，使用 AstBuilder 将语法树转换成 LogicalPlan，这个 LogicalPlan 也被称为 Unresolved LogicalPlan。解析后的逻辑计划如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">=</span><span class="operator">=</span> Parsed Logical Plan <span class="operator">=</span><span class="operator">=</span></span><br><span class="line"><span class="string">&#x27;Project [unresolvedalias(&#x27;</span><span class="built_in">sum</span>(<span class="string">&#x27;v), None)]</span></span><br><span class="line"><span class="string">+- &#x27;</span>SubqueryAlias `iteblog`</span><br><span class="line">   <span class="operator">+</span><span class="operator">-</span> <span class="string">&#x27;Project [&#x27;</span>t1.id, ((<span class="number">1</span> <span class="operator">+</span> <span class="number">2</span>) <span class="operator">+</span> <span class="string">&#x27;t1.value) AS v#16]</span></span><br><span class="line"><span class="string">      +- &#x27;</span><span class="keyword">Filter</span> (((<span class="string">&#x27;t1.id = &#x27;</span>t2.id) <span class="operator">&amp;&amp;</span> (<span class="string">&#x27;t1.cid = 1)) &amp;&amp; ((&#x27;</span>t1.did <span class="operator">=</span> (<span class="string">&#x27;t1.cid + 1)) &amp;&amp; (&#x27;</span>t2.id <span class="operator">&gt;</span> <span class="number">5</span>)))</span><br><span class="line">         <span class="operator">+</span><span class="operator">-</span> <span class="string">&#x27;Join Inner</span></span><br><span class="line"><span class="string">            :- &#x27;</span>UnresolvedRelation `t1`</span><br><span class="line">            <span class="operator">+</span><span class="operator">-</span> <span class="string">&#x27;UnresolvedRelation `t2`</span></span><br></pre></td></tr></table></figure>

<p>图片表示如下：</p>
<p><a target="_blank" rel="noopener" href="https://www.iteblog.com/pic/spark/spark_unresolved_logical_plan-iteblog.jpg"><img src="D:\blog\blog\source_posts\typora-user-images\spark_unresolved_logical_plan-iteblog-1628309732331.jpg" alt="一条SQL在Spark之旅"></a><br>如果想及时了解Spark、Hadoop或者HBase相关的文章，欢迎关注微信公众号：<strong>iteblog_hadoop</strong></p>
<p>Unresolved LogicalPlan 是从下往上看的，t1 和 t2 两张表被生成了 UnresolvedRelation，过滤的条件、选择的列以及聚合字段都知道了，SQL 之旅的第一个过程就算完成了。</p>
<h4 id="3-2-2-绑定逻辑计划阶段-Analyzer"><a href="#3-2-2-绑定逻辑计划阶段-Analyzer" class="headerlink" title="3.2.2 绑定逻辑计划阶段 - Analyzer"></a>3.2.2 绑定逻辑计划阶段 - Analyzer</h4><p>在 SQL 解析阶段生成了 Unresolved LogicalPlan，从上图可以看出逻辑算子树中包含了 UnresolvedRelation 和 unresolvedalias 等对象。Unresolved LogicalPlan 仅仅是一种数据结构，不包含任何数据信息，比如不知道数据源、数据类型，不同的列来自于哪张表等。Analyzer 阶段会使用事先定义好的 Rule 以及 SessionCatalog 等信息对 Unresolved LogicalPlan 进行 transform。SessionCatalog 主要用于各种函数资源信息和元数据信息（数据库、数据表、数据视图、数据分区与函数等）的统一管理。而Rule 是定义在 Analyzer 里面的，如下具体如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">lazy val batches: Seq[Batch] <span class="operator">=</span> Seq(</span><br><span class="line">    Batch(&quot;Hints&quot;, fixedPoint,</span><br><span class="line">      <span class="keyword">new</span> ResolveHints.ResolveBroadcastHints(conf),</span><br><span class="line">      ResolveHints.ResolveCoalesceHints,</span><br><span class="line">      ResolveHints.RemoveAllHints),</span><br><span class="line">    Batch(&quot;Simple Sanity Check&quot;, Once,</span><br><span class="line">      LookupFunctions),</span><br><span class="line">    Batch(&quot;Substitution&quot;, fixedPoint,</span><br><span class="line">      CTESubstitution,</span><br><span class="line">      WindowsSubstitution,</span><br><span class="line">      EliminateUnions,</span><br><span class="line">      <span class="keyword">new</span> SubstituteUnresolvedOrdinals(conf)),</span><br><span class="line">    Batch(&quot;Resolution&quot;, fixedPoint,</span><br><span class="line">      ResolveTableValuedFunctions ::                    <span class="operator">/</span><span class="operator">/</span>解析表的函数</span><br><span class="line">      ResolveRelations ::                               <span class="operator">/</span><span class="operator">/</span>解析表或视图</span><br><span class="line">      ResolveReferences ::                              <span class="operator">/</span><span class="operator">/</span>解析列</span><br><span class="line">      ResolveCreateNamedStruct ::</span><br><span class="line">      ResolveDeserializer ::                            <span class="operator">/</span><span class="operator">/</span>解析反序列化操作类</span><br><span class="line">      ResolveNewInstance ::</span><br><span class="line">      ResolveUpCast ::                                  <span class="operator">/</span><span class="operator">/</span>解析类型转换</span><br><span class="line">      ResolveGroupingAnalytics ::</span><br><span class="line">      ResolvePivot ::</span><br><span class="line">      ResolveOrdinalInOrderByAndGroupBy ::</span><br><span class="line">      ResolveAggAliasInGroupBy ::</span><br><span class="line">      ResolveMissingReferences ::</span><br><span class="line">      ExtractGenerator ::</span><br><span class="line">      ResolveGenerate ::</span><br><span class="line">      ResolveFunctions ::                               <span class="operator">/</span><span class="operator">/</span>解析函数</span><br><span class="line">      ResolveAliases ::                                 <span class="operator">/</span><span class="operator">/</span>解析表别名</span><br><span class="line">      ResolveSubquery ::                                <span class="operator">/</span><span class="operator">/</span>解析子查询</span><br><span class="line">      ResolveSubqueryColumnAliases ::</span><br><span class="line">      ResolveWindowOrder ::</span><br><span class="line">      ResolveWindowFrame ::</span><br><span class="line">      ResolveNaturalAndUsingJoin ::</span><br><span class="line">      ResolveOutputRelation ::</span><br><span class="line">      ExtractWindowExpressions ::</span><br><span class="line">      GlobalAggregates ::</span><br><span class="line">      ResolveAggregateFunctions ::</span><br><span class="line">      TimeWindowing ::</span><br><span class="line">      ResolveInlineTables(conf) ::</span><br><span class="line">      ResolveHigherOrderFunctions(catalog) ::</span><br><span class="line">      ResolveLambdaVariables(conf) ::</span><br><span class="line">      ResolveTimeZone(conf) ::</span><br><span class="line">      ResolveRandomSeed ::</span><br><span class="line">      TypeCoercion.typeCoercionRules(conf) <span class="operator">+</span><span class="operator">+</span></span><br><span class="line">      extendedResolutionRules : _<span class="operator">*</span>),</span><br><span class="line">    Batch(&quot;Post-Hoc Resolution&quot;, Once, postHocResolutionRules: _<span class="operator">*</span>),</span><br><span class="line">    Batch(&quot;View&quot;, Once,</span><br><span class="line">      AliasViewChild(conf)),</span><br><span class="line">    Batch(&quot;Nondeterministic&quot;, Once,</span><br><span class="line">      PullOutNondeterministic),</span><br><span class="line">    Batch(&quot;UDF&quot;, Once,</span><br><span class="line">      HandleNullInputsForUDF),</span><br><span class="line">    Batch(&quot;FixNullability&quot;, Once,</span><br><span class="line">      FixNullability),</span><br><span class="line">    Batch(&quot;Subquery&quot;, Once,</span><br><span class="line">      UpdateOuterReferences),</span><br><span class="line">    Batch(&quot;Cleanup&quot;, fixedPoint,</span><br><span class="line">      CleanupAliases)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>从上面代码可以看出，多个性质类似的 Rule 组成一个 Batch，比如上面名为 Hints 的 Batch就是由很多个 Hints Rule 组成；而多个 Batch 构成一个 batches。这些 batches 会由 RuleExecutor 执行，先按一个一个 Batch 顺序执行，然后对 Batch 里面的每个 Rule 顺序执行。每个 Batch 会之心一次（Once）或多次（FixedPoint，由<br><code>spark.sql.optimizer.maxIterations</code> 参数决定），执行过程如下：</p>
<p><a target="_blank" rel="noopener" href="https://www.iteblog.com/pic/spark/spark_batch_ruleexecutor-iteblog.jpg"><img src="D:\blog\blog\source_posts\typora-user-images\spark_batch_ruleexecutor-iteblog-1628309758409.jpg" alt="一条SQL在Spark之旅"></a><br>如果想及时了解Spark、Hadoop或者HBase相关的文章，欢迎关注微信公众号：<strong>iteblog_hadoop</strong></p>
<p>所以上面的 SQL 经过这个阶段生成的 Analyzed Logical Plan 如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">=</span><span class="operator">=</span> Analyzed Logical Plan <span class="operator">=</span><span class="operator">=</span></span><br><span class="line"><span class="built_in">sum</span>(v): <span class="type">bigint</span></span><br><span class="line">Aggregate [<span class="built_in">sum</span>(<span class="built_in">cast</span>(v#<span class="number">16</span> <span class="keyword">as</span> <span class="type">bigint</span>)) <span class="keyword">AS</span> <span class="built_in">sum</span>(v)#<span class="number">22</span>L]</span><br><span class="line"><span class="operator">+</span><span class="operator">-</span> SubqueryAlias `iteblog`</span><br><span class="line">   <span class="operator">+</span><span class="operator">-</span> Project [id#<span class="number">0</span>, ((<span class="number">1</span> <span class="operator">+</span> <span class="number">2</span>) <span class="operator">+</span> <span class="keyword">value</span>#<span class="number">1</span>) <span class="keyword">AS</span> v#<span class="number">16</span>]</span><br><span class="line">      <span class="operator">+</span><span class="operator">-</span> <span class="keyword">Filter</span> (((id#<span class="number">0</span> <span class="operator">=</span> id#<span class="number">8</span>) <span class="operator">&amp;&amp;</span> (cid#<span class="number">2</span> <span class="operator">=</span> <span class="number">1</span>)) <span class="operator">&amp;&amp;</span> ((did#<span class="number">3</span> <span class="operator">=</span> (cid#<span class="number">2</span> <span class="operator">+</span> <span class="number">1</span>)) <span class="operator">&amp;&amp;</span> (id#<span class="number">8</span> <span class="operator">&gt;</span> <span class="number">5</span>)))</span><br><span class="line">         <span class="operator">+</span><span class="operator">-</span> <span class="keyword">Join</span> <span class="keyword">Inner</span></span><br><span class="line">            :<span class="operator">-</span> SubqueryAlias `t1`</span><br><span class="line">            :  <span class="operator">+</span><span class="operator">-</span> Relation[id#<span class="number">0</span>,<span class="keyword">value</span>#<span class="number">1</span>,cid#<span class="number">2</span>,did#<span class="number">3</span>] csv</span><br><span class="line">            <span class="operator">+</span><span class="operator">-</span> SubqueryAlias `t2`</span><br><span class="line">               <span class="operator">+</span><span class="operator">-</span> Relation[id#<span class="number">8</span>,<span class="keyword">value</span>#<span class="number">9</span>,cid#<span class="number">10</span>,did#<span class="number">11</span>] csv</span><br></pre></td></tr></table></figure>

<p>从上面的结果可以看出，t1 和 t2 表已经解析成带有 id、value、cid 以及 did 四个列的表，其中这个表的数据源来自于 csv 文件。而且每个列的位置和数据类型已经确定了，sum 被解析成 Aggregate 函数了。下面是从 Unresolved LogicalPlan 转换到 Analyzed Logical Plan 对比图。</p>
<p><a target="_blank" rel="noopener" href="https://www.iteblog.com/pic/spark/spark_analyzed_logical_plan-iteblog.jpg"><img src="D:\blog\blog\source_posts\typora-user-images\spark_analyzed_logical_plan-iteblog-1628309758480.jpg" alt="一条SQL在Spark之旅"></a></p>
<p>到这里， Analyzed LogicalPlan 就完全生成了。</p>
<h4 id="3-2-3-优化逻辑计划阶段-Optimizer"><a href="#3-2-3-优化逻辑计划阶段-Optimizer" class="headerlink" title="3.2.3 优化逻辑计划阶段 - Optimizer"></a>3.2.3 优化逻辑计划阶段 - Optimizer</h4><p>在前文的绑定逻辑计划阶段对 Unresolved LogicalPlan 进行相关 transform 操作得到了 Analyzed Logical Plan，这个 Analyzed Logical Plan 是可以直接转换成 Physical Plan 然后在 <a target="_blank" rel="noopener" href="https://www.iteblog.com/archives/tag/spark/">Spark</a> 中执行。但是如果直接这么弄的话，得到的 Physical Plan 很可能不是最优的，因为在实际应用中，很多低效的写法会带来执行效率的问题，需要进一步对Analyzed Logical Plan 进行处理，得到更优的逻辑算子树。于是， 针对 SQL 逻辑算子树的优化器 Optimizer 应运而生。</p>
<p>这个阶段的优化器主要是基于规则的（Rule-based Optimizer，简称 RBO），而绝大部分的规则都是启发式规则，也就是基于直观或经验而得出的规则，比如列裁剪（过滤掉查询不需要使用到的列）、谓词下推（将过滤尽可能地下沉到数据源端）、常量累加（比如 1 + 2 这种事先计算好） 以及常量替换（比如 SELECT * FROM table WHERE i = 5 AND j = i + 3 可以转换成 SELECT * FROM table WHERE i = 5 AND j = 8）等等。</p>
<p>与前文介绍绑定逻辑计划阶段类似，这个阶段所有的规则也是实现 Rule 抽象类，多个规则组成一个 Batch，多个 Batch 组成一个 batches，同样也是在 RuleExecutor 中进行执行，由于前文已经介绍了 Rule 的执行过程，本节就不再赘述。</p>
<p>那么针对前文的 SQL 语句，这个过程都会执行哪些优化呢？这里按照 Rule 执行顺序一一进行说明。</p>
<h5 id="3-2-3-1-谓词下推"><a href="#3-2-3-1-谓词下推" class="headerlink" title="3.2.3.1  谓词下推"></a>3.2.3.1  谓词下推</h5><p>谓词下推在 <a target="_blank" rel="noopener" href="https://www.iteblog.com/archives/tag/spark/">Spark</a> SQL 是由 <code>PushDownPredicate</code> 实现的，这个过程主要将过滤条件尽可能地下推到底层，最好是数据源。所以针对我们上面介绍的 SQL，使用谓词下推优化得到的逻辑计划如下：</p>
<p><a target="_blank" rel="noopener" href="https://www.iteblog.com/pic/spark/spark_pushdownpredicate-iteblog.jpg"><img src="D:\blog\blog\source_posts\typora-user-images\spark_pushdownpredicate-iteblog.jpg" alt="一条SQL在Spark之旅"></a><br>如果想及时了解Spark、Hadoop或者HBase相关的文章，欢迎关注微信公众号：<strong>iteblog_hadoop</strong></p>
<p>从上图可以看出，谓词下推将 Filter 算子直接下推到 Join 之前了（注意，上图是从下往上看的）。也就是在扫描 t1 表的时候会先使用 ((((isnotnull(cid#2) &amp;&amp; isnotnull(did#3)) &amp;&amp; (cid#2 = 1)) &amp;&amp; (did#3 = 2)) &amp;&amp; (id#0 &gt; 50000)) &amp;&amp; isnotnull(id#0) 过滤条件过滤出满足条件的数据；同时在扫描 t2 表的时候会先使用 isnotnull(id#8) &amp;&amp; (id#8 &gt; 50000) 过滤条件过滤出满足条件的数据。经过这样的操作，可以大大减少 Join 算子处理的数据量，从而加快计算速度。</p>
<h5 id="3-2-3-2-列裁剪"><a href="#3-2-3-2-列裁剪" class="headerlink" title="3.2.3.2 列裁剪"></a>3.2.3.2 列裁剪</h5><p>列裁剪在 Spark SQL 是由 <code>ColumnPruning</code> 实现的。因为我们查询的表可能有很多个字段，但是每次查询我们很大可能不需要扫描出所有的字段，这个时候利用列裁剪可以把那些查询不需要的字段过滤掉，使得扫描的数据量减少。所以针对我们上面介绍的 SQL，使用列裁剪优化得到的逻辑计划如下：</p>
<p><a target="_blank" rel="noopener" href="https://www.iteblog.com/pic/spark/spark_columnpruning-iteblog.jpg"><img src="D:\blog\blog\source_posts\typora-user-images\spark_columnpruning-iteblog.jpg" alt="一条SQL在Spark之旅"></a><br>如果想及时了解Spark、Hadoop或者HBase相关的文章，欢迎关注微信公众号：<strong>iteblog_hadoop</strong></p>
<p>从上图可以看出，经过列裁剪后，t1 表只需要查询 id 和 value 两个字段；t2 表只需要查询 id 字段。这样减少了数据的传输，而且如果底层的文件格式为列存（比如 Parquet），可以大大提高数据的扫描速度的。</p>
<h5 id="3-2-3-3-常量替换"><a href="#3-2-3-3-常量替换" class="headerlink" title="3.2.3.3 常量替换"></a>3.2.3.3 常量替换</h5><p>常量替换在 Spark SQL 是由 <code>ConstantPropagation</code> 实现的。也就是将变量替换成常量，比如 SELECT * FROM table WHERE i = 5 AND j = i + 3 可以转换成 SELECT * FROM table WHERE i = 5 AND j = 8。这个看起来好像没什么的，但是如果扫描的行数非常多可以减少很多的计算时间的开销的。经过这个优化，得到的逻辑计划如下：</p>
<p><a target="_blank" rel="noopener" href="https://www.iteblog.com/pic/spark/spark_constantpropagation-iteblog.jpg"><img src="D:\blog\blog\source_posts\typora-user-images\spark_constantpropagation-iteblog.jpg" alt="一条SQL在Spark之旅"></a><br>如果想及时了解Spark、Hadoop或者HBase相关的文章，欢迎关注微信公众号：<strong>iteblog_hadoop</strong></p>
<p>我们的查询中有 <code>t1.cid = 1 AND t1.did = t1.cid + 1</code> 查询语句，从里面可以看出 t1.cid 其实已经是确定的值了，所以我们完全可以使用它计算出 t1.did。</p>
<h5 id="3-2-3-4-常量累加"><a href="#3-2-3-4-常量累加" class="headerlink" title="3.2.3.4 常量累加"></a>3.2.3.4 常量累加</h5><p>常量累加在 Spark SQL 是由 <code>ConstantFolding</code> 实现的。这个和常量替换类似，也是在这个阶段把一些常量表达式事先计算好。这个看起来改动的不大，但是在数据量非常大的时候可以减少大量的计算，减少 CPU 等资源的使用。经过这个优化，得到的逻辑计划如下：</p>
<p><a target="_blank" rel="noopener" href="https://www.iteblog.com/pic/spark/spark_constantfolding-iteblog.jpg"><img src="D:\blog\blog\source_posts\typora-user-images\spark_constantfolding-iteblog.jpg" alt="一条SQL在Spark之旅"></a><br>如果想及时了解Spark、Hadoop或者HBase相关的文章，欢迎关注微信公众号：<strong>iteblog_hadoop</strong></p>
<p>所以经过上面四个步骤的优化之后，得到的优化之后的逻辑计划为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">=</span><span class="operator">=</span> Optimized Logical Plan <span class="operator">=</span><span class="operator">=</span></span><br><span class="line">Aggregate [<span class="built_in">sum</span>(<span class="built_in">cast</span>(v#<span class="number">16</span> <span class="keyword">as</span> <span class="type">bigint</span>)) <span class="keyword">AS</span> <span class="built_in">sum</span>(v)#<span class="number">22</span>L]</span><br><span class="line"><span class="operator">+</span><span class="operator">-</span> Project [(<span class="number">3</span> <span class="operator">+</span> <span class="keyword">value</span>#<span class="number">1</span>) <span class="keyword">AS</span> v#<span class="number">16</span>]</span><br><span class="line">   <span class="operator">+</span><span class="operator">-</span> <span class="keyword">Join</span> <span class="keyword">Inner</span>, (id#<span class="number">0</span> <span class="operator">=</span> id#<span class="number">8</span>)</span><br><span class="line">      :<span class="operator">-</span> Project [id#<span class="number">0</span>, <span class="keyword">value</span>#<span class="number">1</span>]</span><br><span class="line">      :  <span class="operator">+</span><span class="operator">-</span> <span class="keyword">Filter</span> (((((isnotnull(cid#<span class="number">2</span>) <span class="operator">&amp;&amp;</span> isnotnull(did#<span class="number">3</span>)) <span class="operator">&amp;&amp;</span> (cid#<span class="number">2</span> <span class="operator">=</span> <span class="number">1</span>)) <span class="operator">&amp;&amp;</span> (did#<span class="number">3</span> <span class="operator">=</span> <span class="number">2</span>)) <span class="operator">&amp;&amp;</span> (id#<span class="number">0</span> <span class="operator">&gt;</span> <span class="number">5</span>)) <span class="operator">&amp;&amp;</span> isnotnull(id#<span class="number">0</span>))</span><br><span class="line">      :     <span class="operator">+</span><span class="operator">-</span> Relation[id#<span class="number">0</span>,<span class="keyword">value</span>#<span class="number">1</span>,cid#<span class="number">2</span>,did#<span class="number">3</span>] csv</span><br><span class="line">      <span class="operator">+</span><span class="operator">-</span> Project [id#<span class="number">8</span>]</span><br><span class="line">         <span class="operator">+</span><span class="operator">-</span> <span class="keyword">Filter</span> (isnotnull(id#<span class="number">8</span>) <span class="operator">&amp;&amp;</span> (id#<span class="number">8</span> <span class="operator">&gt;</span> <span class="number">5</span>))</span><br><span class="line">            <span class="operator">+</span><span class="operator">-</span> Relation[id#<span class="number">8</span>,<span class="keyword">value</span>#<span class="number">9</span>,cid#<span class="number">10</span>,did#<span class="number">11</span>] csv</span><br></pre></td></tr></table></figure>

<p>对应的图如下：</p>
<p><a target="_blank" rel="noopener" href="https://www.iteblog.com/pic/spark/spark_optimizedlogicalplan-iteblog.jpg"><img src="D:\blog\blog\source_posts\typora-user-images\spark_optimizedlogicalplan-iteblog.jpg" alt="一条SQL在Spark之旅"></a><br>如果想及时了解Spark、Hadoop或者HBase相关的文章，欢迎关注微信公众号：<strong>iteblog_hadoop</strong></p>
<p>到这里，优化逻辑计划阶段就算完成了。另外，Spark 内置提供了多达70个优化 Rule，详情请参见 <a target="_blank" rel="noopener" href="https://www.iteblog.com/redirect.php?url=aHR0cHM6Ly9naXRodWIuY29tL2FwYWNoZS9zcGFyay9ibG9iL21hc3Rlci9zcWwvY2F0YWx5c3Qvc3JjL21haW4vc2NhbGEvb3JnL2FwYWNoZS9zcGFyay9zcWwvY2F0YWx5c3Qvb3B0aW1pemVyL09wdGltaXplci5zY2FsYSNMNTk=&article=true">这里</a>。</p>
<h4 id="3-2-4-可执行物理计划阶段-SparkPlanner"><a href="#3-2-4-可执行物理计划阶段-SparkPlanner" class="headerlink" title="3.2.4 可执行物理计划阶段 - SparkPlanner"></a>3.2.4 可执行物理计划阶段 - SparkPlanner</h4><p>前面介绍的逻辑计划在 Spark 里面其实并不能被执行的，为了能够执行这个 SQL，一定需要翻译成物理计划，到这个阶段 Spark 就知道如何执行这个 SQL 了。和前面逻辑计划绑定和优化不一样，这里使用的是策略（Strategy），而且前面介绍的逻辑计划绑定和优化经过 Transformations 动作之后，树的类型并没有改变，也就是说：Expression 经过 Transformations 之后得到的还是 Transformations ；Logical Plan 经过 Transformations 之后得到的还是 Logical Plan。而到了这个阶段，经过 Transformations 动作之后，树的类型改变了，由 Logical Plan 转换成 Physical Plan 了。</p>
<p>一个逻辑计划（Logical Plan）经过一系列的策略处理之后，得到多个物理计划（Physical Plans），物理计划在 Spark 是由 SparkPlan 实现的。多个物理计划再经过代价模型（Cost Model）得到选择后的物理计划（Selected Physical Plan），整个过程如下所示：</p>
<p>[<img src="D:\blog\blog\source_posts\typora-user-images\spark_cost_model-iteblog.png" alt="一条SQL在Spark之旅"></p>
<p>Cost Model 对应的就是基于代价的优化（Cost-based Optimizations，CBO，主要由华为的大佬们实现的，详见 <a target="_blank" rel="noopener" href="https://www.iteblog.com/redirect.php?url=aHR0cHM6Ly9pc3N1ZXMuYXBhY2hlLm9yZy9qaXJhL2Jyb3dzZS9TUEFSSy0xNjAyNg==&article=true">SPARK-16026</a> ），核心思想是计算每个物理计划的代价，然后得到最优的物理计划。但是在目前最新版的 Spark 2.4.3，这一部分并没有实现，直接返回多个物理计划列表的第一个作为最优的物理计划，如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lazy</span> <span class="keyword">val</span> sparkPlan: <span class="type">SparkPlan</span> = &#123;</span><br><span class="line">    <span class="type">SparkSession</span>.setActiveSession(sparkSession)</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> We use next(), i.e. take the first plan returned by the planner, here for now,</span></span><br><span class="line">    <span class="comment">//       but we will implement to choose the best plan.</span></span><br><span class="line">    planner.plan(<span class="type">ReturnAnswer</span>(optimizedPlan)).next()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而 <a target="_blank" rel="noopener" href="https://www.iteblog.com/redirect.php?url=aHR0cHM6Ly9pc3N1ZXMuYXBhY2hlLm9yZy9qaXJhL2Jyb3dzZS9TUEFSSy0xNjAyNg==&article=true">SPARK-16026</a> 引入的 CBO 优化主要是在前面介绍的<strong>优化逻辑计划阶段 - Optimizer</strong> 阶段进行的，对应的 Rule 为 <code>CostBasedJoinReorder</code>，并且默认是关闭的，需要通过 <code>spark.sql.cbo.enabled</code> 或 <code>spark.sql.cbo.joinReorder.enabled</code> 参数开启。<br>所以到了这个节点，最后得到的物理计划如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">=</span><span class="operator">=</span> Physical Plan <span class="operator">=</span><span class="operator">=</span></span><br><span class="line"><span class="operator">*</span>(<span class="number">3</span>) HashAggregate(keys<span class="operator">=</span>[], functions<span class="operator">=</span>[<span class="built_in">sum</span>(<span class="built_in">cast</span>(v#<span class="number">16</span> <span class="keyword">as</span> <span class="type">bigint</span>))], output<span class="operator">=</span>[<span class="built_in">sum</span>(v)#<span class="number">22</span>L])</span><br><span class="line"><span class="operator">+</span><span class="operator">-</span> Exchange SinglePartition</span><br><span class="line">   <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">2</span>) HashAggregate(keys<span class="operator">=</span>[], functions<span class="operator">=</span>[partial_sum(<span class="built_in">cast</span>(v#<span class="number">16</span> <span class="keyword">as</span> <span class="type">bigint</span>))], output<span class="operator">=</span>[sum#<span class="number">24</span>L])</span><br><span class="line">      <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">2</span>) Project [(<span class="number">3</span> <span class="operator">+</span> <span class="keyword">value</span>#<span class="number">1</span>) <span class="keyword">AS</span> v#<span class="number">16</span>]</span><br><span class="line">         <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">2</span>) BroadcastHashJoin [id#<span class="number">0</span>], [id#<span class="number">8</span>], <span class="keyword">Inner</span>, BuildRight</span><br><span class="line">            :<span class="operator">-</span> <span class="operator">*</span>(<span class="number">2</span>) Project [id#<span class="number">0</span>, <span class="keyword">value</span>#<span class="number">1</span>]</span><br><span class="line">            :  <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">2</span>) <span class="keyword">Filter</span> (((((isnotnull(cid#<span class="number">2</span>) <span class="operator">&amp;&amp;</span> isnotnull(did#<span class="number">3</span>)) <span class="operator">&amp;&amp;</span> (cid#<span class="number">2</span> <span class="operator">=</span> <span class="number">1</span>)) <span class="operator">&amp;&amp;</span> (did#<span class="number">3</span> <span class="operator">=</span> <span class="number">2</span>)) <span class="operator">&amp;&amp;</span> (id#<span class="number">0</span> <span class="operator">&gt;</span> <span class="number">5</span>)) <span class="operator">&amp;&amp;</span> isnotnull(id#<span class="number">0</span>))</span><br><span class="line">            :     <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">2</span>) FileScan csv [id#<span class="number">0</span>,<span class="keyword">value</span>#<span class="number">1</span>,cid#<span class="number">2</span>,did#<span class="number">3</span>] Batched: <span class="literal">false</span>, Format: CSV, Location: InMemoryFileIndex[file:<span class="operator">/</span>iteblog<span class="operator">/</span>t1.csv], PartitionFilters: [], PushedFilters: [IsNotNull(cid), IsNotNull(did), EqualTo(cid,<span class="number">1</span>), EqualTo(did,<span class="number">2</span>), GreaterThan(id,<span class="number">5</span>), IsNotNull(id)], ReadSchema: struct<span class="operator">&lt;</span>id:<span class="type">int</span>,<span class="keyword">value</span>:<span class="type">int</span>,cid:<span class="type">int</span>,did:<span class="type">int</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">+</span><span class="operator">-</span> BroadcastExchange HashedRelationBroadcastMode(List(<span class="built_in">cast</span>(input[<span class="number">0</span>, <span class="type">int</span>, <span class="literal">true</span>] <span class="keyword">as</span> <span class="type">bigint</span>)))</span><br><span class="line">               <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">1</span>) Project [id#<span class="number">8</span>]</span><br><span class="line">                  <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">1</span>) <span class="keyword">Filter</span> (isnotnull(id#<span class="number">8</span>) <span class="operator">&amp;&amp;</span> (id#<span class="number">8</span> <span class="operator">&gt;</span> <span class="number">5</span>))</span><br><span class="line">                     <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">1</span>) FileScan csv [id#<span class="number">8</span>] Batched: <span class="literal">false</span>, Format: CSV, Location: InMemoryFileIndex[file:<span class="operator">/</span>iteblog<span class="operator">/</span>t2.csv], PartitionFilters: [], PushedFilters: [IsNotNull(id), GreaterThan(id,<span class="number">5</span>)], ReadSchema: struct<span class="operator">&lt;</span>id:<span class="type">int</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<p>从上面的结果可以看出，物理计划阶段已经知道数据源是从 csv 文件里面读取了，也知道文件的路径，数据类型等。而且在读取文件的时候，直接将过滤条件（PushedFilters）加进去了。同时，这个 Join 变成了 BroadcastHashJoin，也就是将 t2 表的数据 Broadcast 到 t1 表所在的节点。图表示如下：</p>
<p><a target="_blank" rel="noopener" href="https://www.iteblog.com/pic/spark/spark_physical_plan-iteblog.png"><img src="D:\blog\blog\source_posts\typora-user-images\spark_physical_plan-iteblog.png" alt="一条SQL在Spark之旅"></a><br>如果想及时了解Spark、Hadoop或者HBase相关的文章，欢迎关注微信公众号：<strong>iteblog_hadoop</strong></p>
<p>到这里， Physical Plan 就完全生成了。</p>
<h4 id="3-2-5-全阶段代码生成阶段-WholeStageCodegen"><a href="#3-2-5-全阶段代码生成阶段-WholeStageCodegen" class="headerlink" title="3.2.5 全阶段代码生成阶段 - WholeStageCodegen"></a>3.2.5 全阶段代码生成阶段 - WholeStageCodegen</h4><p>前面我们已经介绍了从逻辑计划生成物理计划（Physical Plan），但是这个物理计划还是不能直接交给 Spark 执行的，Spark 最后仍然会用一些 Rule 对 SparkPlan 进行处理，这个过程是 prepareForExecution 过程，这些 Rule 如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span>` `<span class="function"><span class="keyword">def</span> <span class="title">preparations</span></span>: <span class="type">Seq</span>[<span class="type">Rule</span>[<span class="type">SparkPlan</span>]] = <span class="type">Seq</span>(``  ``<span class="type">PlanSubqueries</span>(sparkSession),             ``<span class="comment">//特殊子查询物理计划处理``  ``EnsureRequirements(sparkSession.sessionState.conf),  ``//确保执行计划分区与排序正确性``  ``CollapseCodegenStages(sparkSession.sessionState.conf), ``//代码生成``  ``ReuseExchange(sparkSession.sessionState.conf),     ``//节点重用``  ``ReuseSubquery(sparkSession.sessionState.conf))     ``//子查询重用</span></span><br></pre></td></tr></table></figure>

<p>上面的 Rule 中 <code>CollapseCodegenStages</code> 是重头戏，这就是大家熟知的全代码阶段生成，Catalyst 全阶段代码生成的入口就是这个规则。当然，如果需要 Spark 进行全阶段代码生成，需要将 <code>spark.sql.codegen.wholeStage</code> 设置为 true（默认）。</p>
<h5 id="3-2-5-1-为什么需要代码生成"><a href="#3-2-5-1-为什么需要代码生成" class="headerlink" title="3.2.5.1 为什么需要代码生成"></a>3.2.5.1 为什么需要代码生成</h5><p>在介绍代码生成之前，我们先来了解一下 Spark SQL 为什么需要引入代码生成。在 Apache Spark 2.0 之前，Spark SQL 的底层实现是基于 Volcano Iterator Model（参见 <a target="_blank" rel="noopener" href="https://www.iteblog.com/redirect.php?url=aHR0cDovL3BhcGVyaHViLnMzLmFtYXpvbmF3cy5jb20vZGFjZTUyYTQyYzA3ZjdmODM0OGIwOGRjMmIxODYwNjEucGRm&article=true">《Volcano-An Extensible and Parallel Query Evaluation System》</a>） 的，这个是由 Goetz Graefe 在 1993 年提出的，当今绝大多数数据库系统处理 SQL 在底层都是基于这个模型的。这个模型的执行可以概括为：首先数据库引擎会将 SQL 翻译成一系列的关系代数算子或表达式，然后依赖这些关系代数算子逐条处理输入数据并产生结果。每个算子在底层都实现同样的接口，比如都实现了 next() 方法，然后最顶层的算子 next() 调用子算子的 next()，子算子的 next() 在调用孙算子的 next()，直到最底层的 next()，具体过程如下图表示：</p>
<p><a target="_blank" rel="noopener" href="https://www.iteblog.com/pic/spark/spark_volcano_iterator_model-iteblog.jpg"><img src="D:\blog\blog\source_posts\typora-user-images\spark_volcano_iterator_model-iteblog.jpg" alt="一条SQL在Spark之旅"></a><br>如果想及时了解Spark、Hadoop或者HBase相关的文章，欢迎关注微信公众号：<strong>iteblog_hadoop</strong></p>
<p>Volcano Iterator Model 的优点是抽象起来很简单，很容易实现，而且可以通过任意组合算子来表达复杂的查询。但是缺点也很明显，存在大量的虚函数调用，会引起 CPU 的中断，最终影响了执行效率。<a target="_blank" rel="noopener" href="https://www.iteblog.com/redirect.php?url=aHR0cHM6Ly9kYXRhYnJpY2tzLmNvbS9ibG9nLzIwMTYvMDUvMjMvYXBhY2hlLXNwYXJrLWFzLWEtY29tcGlsZXItam9pbmluZy1hLWJpbGxpb24tcm93cy1wZXItc2Vjb25kLW9uLWEtbGFwdG9wLmh0bWw=&article=true">数砖的官方博客</a>对比过使用 Volcano Iterator Model 和手写代码的执行效率，结果发现手写的代码执行效率要高出十倍！</p>
<p>基于上面的发现，从 Apache Spark 2.0 开始，社区开始引入了 Whole-stage Code Generation，参见 <a target="_blank" rel="noopener" href="https://www.iteblog.com/redirect.php?url=aHR0cHM6Ly9pc3N1ZXMuYXBhY2hlLm9yZy9qaXJhL2Jyb3dzZS9TUEFSSy0xMjc5NQ==&article=true">SPARK-12795</a>，主要就是想通过这个来模拟手写代码，从而提升 Spark SQL 的执行效率。Whole-stage Code Generation 来自于2011年 Thomas Neumann 发表的 <a target="_blank" rel="noopener" href="https://www.iteblog.com/redirect.php?url=aHR0cDovL3d3dy52bGRiLm9yZy9wdmxkYi92b2w0L3A1MzktbmV1bWFubi5wZGY=&article=true">Efficiently Compiling Efficient Query Plans for Modern Hardware</a> 论文，这个也是 Tungsten 计划的一部分。</p>
<p>Tungsten 代码生成分为三部分：</p>
<ul>
<li>表达式代码生成（expression codegen）</li>
<li>全阶段代码生成（Whole-stage Code Generation）</li>
<li>加速序列化和反序列化（speed up serialization/deserialization）</li>
</ul>
<h5 id="3-2-5-2-表达式代码生成（expression-codegen）"><a href="#3-2-5-2-表达式代码生成（expression-codegen）" class="headerlink" title="3.2.5.2 表达式代码生成（expression codegen）"></a>3.2.5.2 表达式代码生成（expression codegen）</h5><p>这个其实在 Spark 1.x 就有了。表达式代码生成的基类是 org.apache.spark.sql.catalyst.expressions.codegen.CodeGenerator，其下有七个子类：</p>
<p><a target="_blank" rel="noopener" href="https://www.iteblog.com/pic/spark/spark_expression_evaluation-iteblog.png"><img src="D:\blog\blog\source_posts\typora-user-images\spark_expression_evaluation-iteblog.png" alt="一条SQL在Spark之旅"></a><br>如果想及时了解Spark、Hadoop或者HBase相关的文章，欢迎关注微信公众号：<strong>iteblog_hadoop</strong></p>
<p>我们前文的 SQL 生成的逻辑计划中的 <code>isnotnull(id#8) &amp;&amp; (id#8 &gt; 5)</code> 就是最基本的表达式。它也是一种 Predicate，所以会调用 org.apache.spark.sql.catalyst.expressions.codegen.GeneratePredicate 来生成表达式的代码，生成的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>/<span class="number">06</span>/<span class="number">18</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">15</span> DEBUG GeneratePredicate: Generated predicate <span class="string">&#x27;(isnotnull(input[0, int, true]) &amp;&amp; (input[0, int, true] &gt; 5))&#x27;</span>:</span><br><span class="line"><span class="comment">/* 001 */</span> <span class="function"><span class="keyword">public</span> SpecificPredicate <span class="title">generate</span><span class="params">(Object[] references)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* 002 */</span>   <span class="keyword">return</span> <span class="keyword">new</span> SpecificPredicate(references);</span><br><span class="line"><span class="comment">/* 003 */</span> &#125;</span><br><span class="line"><span class="comment">/* 004 */</span></span><br><span class="line"><span class="comment">/* 005 */</span> <span class="class"><span class="keyword">class</span> <span class="title">SpecificPredicate</span> <span class="keyword">extends</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">spark</span>.<span class="title">sql</span>.<span class="title">catalyst</span>.<span class="title">expressions</span>.<span class="title">codegen</span>.<span class="title">Predicate</span> </span>&#123;</span><br><span class="line"><span class="comment">/* 006 */</span>   <span class="keyword">private</span> <span class="keyword">final</span> Object[] references;</span><br><span class="line"><span class="comment">/* 007 */</span></span><br><span class="line"><span class="comment">/* 008 */</span></span><br><span class="line"><span class="comment">/* 009 */</span>   <span class="function"><span class="keyword">public</span> <span class="title">SpecificPredicate</span><span class="params">(Object[] references)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* 010 */</span>     <span class="keyword">this</span>.references = references;</span><br><span class="line"><span class="comment">/* 011 */</span></span><br><span class="line"><span class="comment">/* 012 */</span>   &#125;</span><br><span class="line"><span class="comment">/* 013 */</span></span><br><span class="line"><span class="comment">/* 014 */</span>   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(<span class="keyword">int</span> partitionIndex)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* 015 */</span></span><br><span class="line"><span class="comment">/* 016 */</span>   &#125;</span><br><span class="line"><span class="comment">/* 017 */</span></span><br><span class="line"><span class="comment">/* 018 */</span>   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">eval</span><span class="params">(InternalRow i)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* 019 */</span>     <span class="keyword">boolean</span> isNull_2 = i.isNullAt(<span class="number">0</span>);         <span class="comment">//判断id是否为空</span></span><br><span class="line"><span class="comment">/* 020 */</span>     <span class="keyword">int</span> value_2 = isNull_2 ?</span><br><span class="line"><span class="comment">/* 021 */</span>     -<span class="number">1</span> : (i.getInt(<span class="number">0</span>));</span><br><span class="line"><span class="comment">/* 022 */</span>     <span class="keyword">boolean</span> isNull_0 = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">/* 023 */</span>     <span class="keyword">boolean</span> value_0 = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">/* 024 */</span></span><br><span class="line"><span class="comment">/* 025 */</span>     <span class="keyword">if</span> (!<span class="keyword">false</span> &amp;&amp; !(!isNull_2)) &#123;             <span class="comment">//如果id为空那么整个表达式就是false</span></span><br><span class="line"><span class="comment">/* 026 */</span>     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/* 027 */</span>       <span class="keyword">boolean</span> isNull_3 = <span class="keyword">true</span>;</span><br><span class="line"><span class="comment">/* 028 */</span>       <span class="keyword">boolean</span> value_3 = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">/* 029 */</span>       <span class="keyword">boolean</span> isNull_4 = i.isNullAt(<span class="number">0</span>);       <span class="comment">//继续判断id是否为空</span></span><br><span class="line"><span class="comment">/* 030 */</span>       <span class="keyword">int</span> value_4 = isNull_4 ?                <span class="comment">//根据id值为空获取对应的值</span></span><br><span class="line"><span class="comment">/* 031 */</span>       -<span class="number">1</span> : (i.getInt(<span class="number">0</span>));</span><br><span class="line"><span class="comment">/* 032 */</span>       <span class="keyword">if</span> (!isNull_4) &#123;                    <span class="comment">//如果id对应的值不为空，那么判断这个值是否大于5</span></span><br><span class="line"><span class="comment">/* 033 */</span></span><br><span class="line"><span class="comment">/* 034 */</span></span><br><span class="line"><span class="comment">/* 035 */</span>         isNull_3 = <span class="keyword">false</span>; <span class="comment">// resultCode could change nullability.</span></span><br><span class="line"><span class="comment">/* 036 */</span>         value_3 = value_4 &gt; <span class="number">5</span>;</span><br><span class="line"><span class="comment">/* 037 */</span></span><br><span class="line"><span class="comment">/* 038 */</span>       &#125;</span><br><span class="line"><span class="comment">/* 039 */</span>       <span class="keyword">if</span> (!isNull_3 &amp;&amp; !value_3) &#123;</span><br><span class="line"><span class="comment">/* 040 */</span>       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">false</span> &amp;&amp; !isNull_3) &#123;      <span class="comment">//id之大于5</span></span><br><span class="line"><span class="comment">/* 041 */</span>         value_0 = <span class="keyword">true</span>;</span><br><span class="line"><span class="comment">/* 042 */</span>       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/* 043 */</span>         isNull_0 = <span class="keyword">true</span>;</span><br><span class="line"><span class="comment">/* 044 */</span>       &#125;</span><br><span class="line"><span class="comment">/* 045 */</span>     &#125;</span><br><span class="line"><span class="comment">/* 046 */</span>     <span class="keyword">return</span> !isNull_0 &amp;&amp; value_0;   <span class="comment">//这个就是表达式isnotnull(id#8) &amp;&amp; (id#8 &gt; 5)对每行执行的结果          </span></span><br><span class="line"><span class="comment">/* 047 */</span>   &#125;</span><br><span class="line"><span class="comment">/* 048 */</span></span><br><span class="line"><span class="comment">/* 049 */</span></span><br><span class="line"><span class="comment">/* 050 */</span> &#125;</span><br></pre></td></tr></table></figure>

<p>上面就是对表达式 <code>isnotnull(id#8) &amp;&amp; (id#8 &gt; 5)</code> 生成的代码，里面用到了 org.apache.spark.sql.catalyst.expressions.And、org.apache.spark.sql.catalyst.expressions.IsNotNull 以及 org.apache.spark.sql.catalyst.expressions.GreaterThan 三个 Predicate 的代码生成，然后组成了上面的 SpecificPredicate 。SpecificPredicate 会对每行应用 <code>eval</code> 函数去判断是否满足条件，上面生成的 SpecificPredicate 类逻辑并不复杂，大家可以去细细品味。</p>
<p>表达式代码生成主要是想解决大量虚函数调用（Virtual Function Calls），泛化的代价等。需要注意的是，上面通过表达式生成完整的类代码只有在将 <code>spark.sql.codegen.wholeStage</code> 设置为 false 才会进行的，否则只会生成一部分代码，并且和其他代码组成 Whole-stage Code。</p>
<h5 id="3-2-5-3-全阶段代码生成（Whole-stage-Code-Generation）"><a href="#3-2-5-3-全阶段代码生成（Whole-stage-Code-Generation）" class="headerlink" title="3.2.5.3 全阶段代码生成（Whole-stage Code Generation）"></a>3.2.5.3 全阶段代码生成（Whole-stage Code Generation）</h5><p>全阶段代码生成（Whole-stage Code Generation），用来将多个处理逻辑整合到单个代码模块中，其中也会用到上面的表达式代码生成。和前面介绍的表达式代码生成不一样，这个是对整个 SQL 过程进行代码生成，前面的表达式代码生成仅对于表达式的。全阶段代码生成都是继承自 org.apache.spark.sql.execution.BufferedRowIterator 的，生成的代码需要实现 processNext() 方法，这个方法会在 org.apache.spark.sql.execution.WholeStageCodegenExec 里面的 doExecute 方法里面被调用。而这个方法里面的 rdd 会将数据传进生成的代码里面 ，比如我们上文 SQL 这个例子的数据源是 csv 文件，底层使用 org.apache.spark.sql.execution.FileSourceScanExec 这个类读取文件，然后生成 inputRDD，这个 rdd 在 WholeStageCodegenExec 类中的 doExecute 方法里面调用生成的代码，然后执行我们各种判断得到最后的结果。WholeStageCodegenExec 类中的 doExecute 方法部分代码如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rdds 可以从 FileSourceScanExec 的 inputRDDs 方法获取</span></span><br><span class="line"><span class="keyword">val</span> rdds = child.asInstanceOf[<span class="type">CodegenSupport</span>].inputRDDs()</span><br><span class="line"> </span><br><span class="line">......</span><br><span class="line"> </span><br><span class="line">rdds.head.mapPartitionsWithIndex &#123; (index, iter) =&gt;</span><br><span class="line">    <span class="comment">// 编译生成好的代码</span></span><br><span class="line">    <span class="keyword">val</span> (clazz, _) = <span class="type">CodeGenerator</span>.compile(cleanedSource)</span><br><span class="line">    <span class="comment">// 前面说了所有生成的代码都是继承自 BufferedRowIterator</span></span><br><span class="line">    <span class="keyword">val</span> buffer = clazz.generate(references).asInstanceOf[<span class="type">BufferedRowIterator</span>]</span><br><span class="line">    <span class="comment">// 调用生成代码的 init 方法，主要传入 iter 迭代器，这里面就是我们要的数据</span></span><br><span class="line">    buffer.init(index, <span class="type">Array</span>(iter))</span><br><span class="line">    <span class="keyword">new</span> <span class="type">Iterator</span>[<span class="type">InternalRow</span>] &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">hasNext</span></span>: <span class="type">Boolean</span> = &#123;</span><br><span class="line">        <span class="comment">// 这个会调用生成的代码中 processNext() 方法，里面就会根据表达式对每行数据进行判断</span></span><br><span class="line">        <span class="keyword">val</span> v = buffer.hasNext</span><br><span class="line">        <span class="keyword">if</span> (!v) durationMs += buffer.durationMs()</span><br><span class="line">        v</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">next</span></span>: <span class="type">InternalRow</span> = buffer.next()</span><br><span class="line">    &#125;</span><br><span class="line">｝</span><br><span class="line"> </span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>那么我们生成的代码长什么样呢？我们还是对前面文章的 SQL 进行分析，这个 SQL 生成的物理计划如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">=</span><span class="operator">=</span> Physical Plan <span class="operator">=</span><span class="operator">=</span></span><br><span class="line"><span class="operator">*</span>(<span class="number">3</span>) HashAggregate(keys<span class="operator">=</span>[], functions<span class="operator">=</span>[<span class="built_in">sum</span>(<span class="built_in">cast</span>(v#<span class="number">16</span> <span class="keyword">as</span> <span class="type">bigint</span>))], output<span class="operator">=</span>[<span class="built_in">sum</span>(v)#<span class="number">22</span>L])</span><br><span class="line"><span class="operator">+</span><span class="operator">-</span> Exchange SinglePartition</span><br><span class="line">   <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">2</span>) HashAggregate(keys<span class="operator">=</span>[], functions<span class="operator">=</span>[partial_sum(<span class="built_in">cast</span>(v#<span class="number">16</span> <span class="keyword">as</span> <span class="type">bigint</span>))], output<span class="operator">=</span>[sum#<span class="number">24</span>L])</span><br><span class="line">      <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">2</span>) Project [(<span class="number">3</span> <span class="operator">+</span> <span class="keyword">value</span>#<span class="number">1</span>) <span class="keyword">AS</span> v#<span class="number">16</span>]</span><br><span class="line">         <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">2</span>) BroadcastHashJoin [id#<span class="number">0</span>], [id#<span class="number">8</span>], <span class="keyword">Inner</span>, BuildRight</span><br><span class="line">            :<span class="operator">-</span> <span class="operator">*</span>(<span class="number">2</span>) Project [id#<span class="number">0</span>, <span class="keyword">value</span>#<span class="number">1</span>]</span><br><span class="line">            :  <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">2</span>) <span class="keyword">Filter</span> (((((isnotnull(cid#<span class="number">2</span>) <span class="operator">&amp;&amp;</span> isnotnull(did#<span class="number">3</span>)) <span class="operator">&amp;&amp;</span> (cid#<span class="number">2</span> <span class="operator">=</span> <span class="number">1</span>)) <span class="operator">&amp;&amp;</span> (did#<span class="number">3</span> <span class="operator">=</span> <span class="number">2</span>)) <span class="operator">&amp;&amp;</span> (id#<span class="number">0</span> <span class="operator">&gt;</span> <span class="number">5</span>)) <span class="operator">&amp;&amp;</span> isnotnull(id#<span class="number">0</span>))</span><br><span class="line">            :     <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">2</span>) FileScan csv [id#<span class="number">0</span>,<span class="keyword">value</span>#<span class="number">1</span>,cid#<span class="number">2</span>,did#<span class="number">3</span>] Batched: <span class="literal">false</span>, Format: CSV, Location: InMemoryFileIndex[file:<span class="operator">/</span>iteblog<span class="operator">/</span>t1.csv], PartitionFilters: [], PushedFilters: [IsNotNull(cid), IsNotNull(did), EqualTo(cid,<span class="number">1</span>), EqualTo(did,<span class="number">2</span>), GreaterThan(id,<span class="number">5</span>), IsNotNull(id)], ReadSchema: struct<span class="operator">&lt;</span>id:<span class="type">int</span>,<span class="keyword">value</span>:<span class="type">int</span>,cid:<span class="type">int</span>,did:<span class="type">int</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">+</span><span class="operator">-</span> BroadcastExchange HashedRelationBroadcastMode(List(<span class="built_in">cast</span>(input[<span class="number">0</span>, <span class="type">int</span>, <span class="literal">true</span>] <span class="keyword">as</span> <span class="type">bigint</span>)))</span><br><span class="line">               <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">1</span>) Project [id#<span class="number">8</span>]</span><br><span class="line">                  <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">1</span>) <span class="keyword">Filter</span> (isnotnull(id#<span class="number">8</span>) <span class="operator">&amp;&amp;</span> (id#<span class="number">8</span> <span class="operator">&gt;</span> <span class="number">5</span>))</span><br><span class="line">                     <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">1</span>) FileScan csv [id#<span class="number">8</span>] Batched: <span class="literal">false</span>, Format: CSV, Location: InMemoryFileIndex[file:<span class="operator">/</span>iteblog<span class="operator">/</span>t2.csv], PartitionFilters: [], PushedFilters: [IsNotNull(id), GreaterThan(id,<span class="number">5</span>)], ReadSchema: struct<span class="operator">&lt;</span>id:<span class="type">int</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<p>从上面的物理计划可以看出，整个 SQL 的执行分为三个阶段。为了简便起见，我们仅仅分析第一个阶段的代码生成，也就是下面物理计划：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">1</span>) Project [id#<span class="number">8</span>]</span><br><span class="line">   <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">1</span>) <span class="keyword">Filter</span> (isnotnull(id#<span class="number">8</span>) <span class="operator">&amp;&amp;</span> (id#<span class="number">8</span> <span class="operator">&gt;</span> <span class="number">5</span>))</span><br><span class="line">      <span class="operator">+</span><span class="operator">-</span> <span class="operator">*</span>(<span class="number">1</span>) FileScan csv [id#<span class="number">8</span>] Batched: <span class="literal">false</span>, Format: CSV, Location: InMemoryFileIndex[file:<span class="operator">/</span>iteblog<span class="operator">/</span>t2.csv], PartitionFilters: [], PushedFilters: [IsNotNull(id), GreaterThan(id,<span class="number">5</span>)], ReadSchema: struct<span class="operator">&lt;</span>id:<span class="type">int</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过全阶段代码生成，上面过程得到的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">Generated code:</span><br><span class="line"><span class="comment">/* 001 */</span> <span class="function"><span class="keyword">public</span> Object <span class="title">generate</span><span class="params">(Object[] references)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* 002 */</span>   <span class="keyword">return</span> <span class="keyword">new</span> GeneratedIteratorForCodegenStage1(references);</span><br><span class="line"><span class="comment">/* 003 */</span> &#125;</span><br><span class="line"><span class="comment">/* 004 */</span></span><br><span class="line"><span class="comment">/* 005 */</span> <span class="comment">// codegenStageId=1</span></span><br><span class="line"><span class="comment">/* 006 */</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GeneratedIteratorForCodegenStage1</span> <span class="keyword">extends</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">spark</span>.<span class="title">sql</span>.<span class="title">execution</span>.<span class="title">BufferedRowIterator</span> </span>&#123;</span><br><span class="line"><span class="comment">/* 007 */</span>   <span class="keyword">private</span> Object[] references;</span><br><span class="line"><span class="comment">/* 008 */</span>   <span class="keyword">private</span> scala.collection.Iterator[] inputs;</span><br><span class="line"><span class="comment">/* 009 */</span>   <span class="keyword">private</span> org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[] filter_mutableStateArray_0 = <span class="keyword">new</span> org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[<span class="number">2</span>];</span><br><span class="line"><span class="comment">/* 010 */</span>   <span class="keyword">private</span> scala.collection.Iterator[] scan_mutableStateArray_0 = <span class="keyword">new</span> scala.collection.Iterator[<span class="number">1</span>];</span><br><span class="line"><span class="comment">/* 011 */</span></span><br><span class="line"><span class="comment">/* 012 */</span>   <span class="function"><span class="keyword">public</span> <span class="title">GeneratedIteratorForCodegenStage1</span><span class="params">(Object[] references)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* 013 */</span>     <span class="keyword">this</span>.references = references;</span><br><span class="line"><span class="comment">/* 014 */</span>   &#125;</span><br><span class="line"><span class="comment">/* 015 */</span></span><br><span class="line"><span class="comment">/* 016 */</span>   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> index, scala.collection.Iterator[] inputs)</span> </span>&#123;   <span class="comment">//在WholeStageCodegenExec类中的doExecute被调用</span></span><br><span class="line"><span class="comment">/* 017 */</span>     partitionIndex = index;</span><br><span class="line"><span class="comment">/* 018 */</span>     <span class="keyword">this</span>.inputs = inputs;</span><br><span class="line"><span class="comment">/* 019 */</span>     scan_mutableStateArray_0[<span class="number">0</span>] = inputs[<span class="number">0</span>];</span><br><span class="line"><span class="comment">/* 020 */</span>     filter_mutableStateArray_0[<span class="number">0</span>] = <span class="keyword">new</span> org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">/* 021 */</span>     filter_mutableStateArray_0[<span class="number">1</span>] = <span class="keyword">new</span> org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">/* 022 */</span></span><br><span class="line"><span class="comment">/* 023 */</span>   &#125;</span><br><span class="line"><span class="comment">/* 024 */</span></span><br><span class="line"><span class="comment">/* 025 */</span>   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processNext</span><span class="params">()</span> <span class="keyword">throws</span> java.io.IOException </span>&#123;  <span class="comment">//处理每行数据，这个就是isnotnull(id#8) &amp;&amp; (id#8 &gt; 5)表达式的判断</span></span><br><span class="line"><span class="comment">/* 026 */</span>     <span class="keyword">while</span> (scan_mutableStateArray_0[<span class="number">0</span>].hasNext()) &#123;</span><br><span class="line"><span class="comment">/* 027 */</span>       InternalRow scan_row_0 = (InternalRow) scan_mutableStateArray_0[<span class="number">0</span>].next();</span><br><span class="line"><span class="comment">/* 028 */</span>       ((org.apache.spark.sql.execution.metric.SQLMetric) references[<span class="number">0</span>] <span class="comment">/* numOutputRows */</span>).add(<span class="number">1</span>);</span><br><span class="line"><span class="comment">/* 029 */</span>       <span class="keyword">do</span> &#123;</span><br><span class="line"><span class="comment">/* 030 */</span>         <span class="keyword">boolean</span> scan_isNull_0 = scan_row_0.isNullAt(<span class="number">0</span>);     <span class="comment">//判断id是否为空</span></span><br><span class="line"><span class="comment">/* 031 */</span>         <span class="keyword">int</span> scan_value_0 = scan_isNull_0 ?                  <span class="comment">//如果为空则scan_value_0等于－1，否则就是id的值</span></span><br><span class="line"><span class="comment">/* 032 */</span>         -<span class="number">1</span> : (scan_row_0.getInt(<span class="number">0</span>));</span><br><span class="line"><span class="comment">/* 033 */</span></span><br><span class="line"><span class="comment">/* 034 */</span>         <span class="keyword">if</span> (!(!scan_isNull_0)) <span class="keyword">continue</span>;                   <span class="comment">//如果id为空这行数据就不要了</span></span><br><span class="line"><span class="comment">/* 035 */</span></span><br><span class="line"><span class="comment">/* 036 */</span>         <span class="keyword">boolean</span> filter_value_2 = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">/* 037 */</span>         filter_value_2 = scan_value_0 &gt; <span class="number">5</span>;                 <span class="comment">//id是否大于5</span></span><br><span class="line"><span class="comment">/* 038 */</span>         <span class="keyword">if</span> (!filter_value_2) <span class="keyword">continue</span>;                     <span class="comment">//如果id不大于5，则这行数据不要了</span></span><br><span class="line"><span class="comment">/* 039 */</span></span><br><span class="line"><span class="comment">/* 040 */</span>         ((org.apache.spark.sql.execution.metric.SQLMetric) references[<span class="number">1</span>] <span class="comment">/* numOutputRows */</span>).add(<span class="number">1</span>);</span><br><span class="line"><span class="comment">/* 041 */</span></span><br><span class="line"><span class="comment">/* 042 */</span>         filter_mutableStateArray_0[<span class="number">1</span>].reset();</span><br><span class="line"><span class="comment">/* 043 */</span></span><br><span class="line"><span class="comment">/* 044 */</span>         <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line"><span class="comment">/* 045 */</span>           filter_mutableStateArray_0[<span class="number">1</span>].setNullAt(<span class="number">0</span>);</span><br><span class="line"><span class="comment">/* 046 */</span>         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/* 047 */</span>           filter_mutableStateArray_0[<span class="number">1</span>].write(<span class="number">0</span>, scan_value_0);  <span class="comment">//这个就是符合isnotnull(id#8) &amp;&amp; (id#8 &gt; 5)表达式的id</span></span><br><span class="line"><span class="comment">/* 048 */</span>         &#125;</span><br><span class="line"><span class="comment">/* 049 */</span>         append((filter_mutableStateArray_0[<span class="number">1</span>].getRow()));        <span class="comment">//得到符号条件的行</span></span><br><span class="line"><span class="comment">/* 050 */</span></span><br><span class="line"><span class="comment">/* 051 */</span>       &#125; <span class="keyword">while</span>(<span class="keyword">false</span>);</span><br><span class="line"><span class="comment">/* 052 */</span>       <span class="keyword">if</span> (shouldStop()) <span class="keyword">return</span>;</span><br><span class="line"><span class="comment">/* 053 */</span>     &#125;</span><br><span class="line"><span class="comment">/* 054 */</span>   &#125;</span><br><span class="line"><span class="comment">/* 055 */</span></span><br><span class="line"><span class="comment">/* 056 */</span> &#125;</span><br></pre></td></tr></table></figure>

<p>上面代码逻辑很好理解，大部分代码我都注释了，其实就是对每行的 id 进行 isnotnull(id#8) &amp;&amp; (id#8 &gt; 5) 表达式判断，然后拿到符合条件的行。剩余的其他阶段的代码生成和这个类似，生成的代码有点多，我就不贴出来了，感兴趣的同学可以自己去看下。相比 Volcano Iterator Model，全阶段代码生成的执行过程如下：</p>
<p><a target="_blank" rel="noopener" href="https://www.iteblog.com/pic/spark/spark_wholesagecodegen-iteblog.png"><img src="D:\blog\blog\source_posts\typora-user-images\spark_wholesagecodegen-iteblog.png" alt="一条SQL在Spark之旅"></a><br>如果想及时了解Spark、Hadoop或者HBase相关的文章，欢迎关注微信公众号：<strong>iteblog_hadoop</strong></p>
<p>通过引入全阶段代码生成，大大减少了虚函数的调用，减少了 CPU 的调用，使得 SQL 的执行速度有很大提升。</p>
<h4 id="3-2-6-代码编译"><a href="#3-2-6-代码编译" class="headerlink" title="3.2.6 代码编译"></a>3.2.6 代码编译</h4><p>生成代码之后需要解决的另一个问题是如何将生成的代码进行编译然后加载到同一个 JVM 中去。在早期 Spark 版本是使用 Scala 的 Reflection 和 Quasiquotes 机制来实现代码生成的。Quasiquotes 是一个简洁的符号，可以让我们轻松操作 Scala 语法树，具体参见 <a target="_blank" rel="noopener" href="https://www.iteblog.com/redirect.php?url=aHR0cHM6Ly9kb2NzLnNjYWxhLWxhbmcub3JnL292ZXJ2aWV3cy9xdWFzaXF1b3Rlcy9pbnRyby5odG1s&article=true">这里</a>。虽然 Quasiquotes 可以很好的为我们解决代码生成等相关的问题，但是带来的新问题是编译代码时间比较长（大约 50ms - 500ms）！所以社区不得不默认关闭表达式代码生成。</p>
<p>为了解决这个问题，Spark 引入了 Janino 项目，参见 <a target="_blank" rel="noopener" href="https://www.iteblog.com/redirect.php?url=aHR0cHM6Ly9pc3N1ZXMuYXBhY2hlLm9yZy9qaXJhL2Jyb3dzZS9TUEFSSy03OTU2&article=true">SPARK-7956</a>。Janino 是一个超级小但又超级快的 Java™ 编译器. 它不仅能像 javac 工具那样将一组源文件编译成字节码文件，还可以对一些 Java 表达式，代码块，类中的文本(class body)或者内存中源文件进行编译，并把编译后的字节码直接加载到同一个 JVM 中运行。Janino 不是一个开发工具, 而是作为运行时的嵌入式编译器，比如作为表达式求值的翻译器或类似于 JSP 的服务端页面引擎，关于 Janino 的更多知识请参见<a target="_blank" rel="noopener" href="https://www.iteblog.com/redirect.php?url=aHR0cHM6Ly9qYW5pbm8tY29tcGlsZXIuZ2l0aHViLmlvL2phbmluby8=&article=true">这里</a>。通过引入了 Janino 来编译生成的代码，结果显示 SQL 表达式的编译时间减少到 5ms。在 Spark 中使用了 <code>ClassBodyEvaluator</code> 来编译生成之后的代码，参见 org.apache.spark.sql.catalyst.expressions.codegen.CodeGenerator。</p>
<p><strong>需要主要的是，代码生成是在 Driver 端进行的，而代码编译是在 Executor 端进行的。</strong></p>
<h4 id="3-2-7-SQL-执行"><a href="#3-2-7-SQL-执行" class="headerlink" title="3.2.7 SQL 执行"></a>3.2.7 SQL 执行</h4><p>终于到了 SQL 真正执行的地方了。这个时候 Spark 会执行上阶段生成的代码，然后得到最终的结果，DAG 执行图如下：</p>
<p><a target="_blank" rel="noopener" href="https://www.iteblog.com/pic/spark/spark_dag-iteblog.png"><img src="D:\blog\blog\source_posts\typora-user-images\spark_dag-iteblog-1628310067147.png" alt="一条SQL在Spark之旅"></a></p>
<h3 id="3-3-spark-shuffle-源码"><a href="#3-3-spark-shuffle-源码" class="headerlink" title="3.3 spark shuffle 源码"></a>3.3 spark shuffle 源码</h3><p>在使用 Spark 进行计算时，我们经常会碰到作业 (Job) Out Of Memory(OOM) 的情况，而且很大一部分情况是发生在 Shuffle 阶段。那么在 Spark Shuffle 中具体是哪些地方会使用比较多的内存而有可能导致 OOM 呢？ 为此，本文将围绕以上问题梳理 Spark 内存管理和 Shuffle 过程中与内存使用相关的知识；然后，简要分析下在 Spark Shuffle 中有可能导致 OOM 的原因。</p>
<h4 id="3-3-1-Spark-内存管理和消费模型"><a href="#3-3-1-Spark-内存管理和消费模型" class="headerlink" title="3.3.1 Spark 内存管理和消费模型"></a>3.3.1 Spark 内存管理和消费模型</h4><p>在分析 Spark Shuffle 内存使用之前。我们首先了解下以下问题：当一个 Spark 子任务 (Task) 被分配到 Executor 上运行时，Spark 管理内存以及消费内存的大体模型是什么样呢？（注：由于 OOM 主要发生在 Executor 端，所以接下来的讨论主要针对 Executor 端的内存管理和使用）。</p>
<p>1，在 Spark 中，使用抽象类 MemoryConsumer 来表示需要使用内存的消费者。在这个类中定义了分配，释放以及 Spill 内存数据到磁盘的一些方法或者接口。具体的消费者可以继承 MemoryConsumer 从而实现具体的行为。 因此，在 Spark Task 执行过程中，会有各种类型不同，数量不一的具体消费者。如在 Spark Shuffle 中使用的 ExternalAppendOnlyMap, ExternalSorter 等等（具体后面会分析）。</p>
<p>2，MemoryConsumer 会将申请，释放相关内存的工作交由 TaskMemoryManager 来执行。当一个 Spark Task 被分配到 Executor 上运行时，会创建一个 TaskMemoryManager。在 TaskMemoryManager 执行分配内存之前，需要首先向 MemoryManager 进行申请，然后由 TaskMemoryManager 借助 MemoryAllocator 执行实际的内存分配。 </p>
<p>3，Executor 中的 MemoryManager 会统一管理内存的使用。由于每个 TaskMemoryManager 在执行实际的内存分配之前，会首先向 MemoryManager 提出申请。因此 MemoryManager 会对当前进程使用内存的情况有着全局的了解。</p>
<p>MemoryManager，TaskMemoryManager 和 MemoryConsumer 之前的对应关系，如下图。总体上，一个 MemoryManager 对应着至少一个 TaskMemoryManager （具体由 executor-core 参数指定），而一个 TaskMemoryManager 对应着多个 MemoryConsumer (具体由任务而定)。<br><img src="D:\blog\blog\source_posts\typora-user-images\memory_consumer.jpeg" alt="consumerModel">了解了以上内存消费的整体过程以后，有两个问题需要注意下：<br>1，当有多个 Task 同时在 Executor 上执行时， 将会有多个 TaskMemoryManager 共享 MemoryManager 管理的内存。那么 MemoryManager 是怎么分配的呢？答案是每个任务可以分配到的内存范围是 [1 / (2 * n), 1 / n]，其中 n 是正在运行的 Task 个数。因此，多个并发运行的 Task 会使得每个 Task 可以获得的内存变小。</p>
<p>2，前面提到，在 MemoryConsumer 中有 Spill 方法，当 MemoryConsumer 申请不到足够的内存时，可以 Spill 当前内存到磁盘，从而避免无节制的使用内存。但是，对于堆内内存的申请和释放实际是由 JVM 来管理的。因此，在统计堆内内存具体使用量时，考虑性能等各方面原因，Spark 目前采用的是抽样统计的方式来计算 MemoryConsumer 已经使用的内存，从而造成堆内内存的实际使用量不是特别准确。从而有可能因为不能及时 Spill 而导致 OOM。</p>
<h4 id="3-3-2-Spark-Shuffle-过程"><a href="#3-3-2-Spark-Shuffle-过程" class="headerlink" title="3.3.2 Spark Shuffle 过程"></a>3.3.2 Spark Shuffle 过程</h4><p>整体上 Spark Shuffle 具体过程如下图，主要分为两个阶段：Shuffle Write 和 Shuffle Read。</p>
<p>Write 阶段大体经历排序（最低要求是需要按照分区进行排序），可能的聚合 (combine) 和归并（有多个文件 spill 磁盘的情况 ），最终每个写 Task 会产生数据和索引两个文件。其中，数据文件会按照分区进行存储，即相同分区的数据在文件中是连续的，而索引文件记录了每个分区在文件中的起始和结束位置。</p>
<p>而对于 Shuffle Read， 首先可能需要通过网络从各个 Write 任务节点获取给定分区的数据，即数据文件中某一段连续的区域，然后经过排序，归并等过程，最终形成计算结果。<img src="D:\blog\blog\source_posts\typora-user-images\spark_shuffle.jpeg" alt="sparkShuffle">对于 Shuffle Write，Spark 当前有三种实现，具体分别为 BypassMergeSortShuffleWriter, UnsafeShuffleWriter 和 SortShuffleWriter （具体使用哪一个实现有一个判断条件，此处不表）。而 Shuffle Read 只有一种实现。</p>
<h5 id="3-3-2-1-Shuffle-Write-阶段分析"><a href="#3-3-2-1-Shuffle-Write-阶段分析" class="headerlink" title="3.3.2.1  Shuffle Write 阶段分析"></a>3.3.2.1  Shuffle Write 阶段分析</h5><h6 id="3-3-2-1-1-BypassMergeSortShuffleWriter-分析"><a href="#3-3-2-1-1-BypassMergeSortShuffleWriter-分析" class="headerlink" title="3.3.2.1.1 BypassMergeSortShuffleWriter 分析"></a>3.3.2.1.1 BypassMergeSortShuffleWriter 分析</h6><p>对于 BypassMergeSortShuffleWriter 的实现，大体实现过程是首先为每个分区创建一个临时分区文件，数据写入对应的分区文件，最终所有的分区文件合并成一个数据文件，并且产生一个索引文件。由于这个过程不做排序，combine（如果需要 combine 不会使用这个实现）等操作，因此对于 BypassMergeSortShuffleWriter，总体来说是不怎么耗费内存的。</p>
<h6 id="3-3-2-1-2-SortShuffleWriter-分析"><a href="#3-3-2-1-2-SortShuffleWriter-分析" class="headerlink" title="3.3.2.1.2 SortShuffleWriter 分析"></a>3.3.2.1.2 SortShuffleWriter 分析</h6><p>SortShuffleWriter 是最一般的实现，也是日常使用最频繁的。SortShuffleWriter 主要委托 ExternalSorter 做数据插入，排序，归并 （Merge），聚合 (Combine) 以及最终写数据和索引文件的工作。ExternalSorter 实现了之前提到的 MemoryConsumer 接口。下面分析一下各个过程使用内存的情况：</p>
<p>1，对于数据写入，根据是否需要做 Combine，数据会被插入到 PartitionedAppendOnlyMap 这个 Map 或者 PartitionedPairBuffer 这个数组中。每隔一段时间，当向 MemoryManager 申请不到足够的内存时，或者数据量超过 spark.shuffle.spill.numElementsForceSpillThreshold 这个阈值时 （默认是 Long 的最大值，不起作用），就会进行 Spill 内存数据到文件。假设可以源源不断的申请到内存，那么 Write 阶段的所有数据将一直保存在内存中，由此可见，PartitionedAppendOnlyMap 或者 PartitionedPairBuffer 是比较吃内存的。 </p>
<p>2，无论是 PartitionedAppendOnlyMap 还是 PartitionedPairBuffer， 使用的排序算法是 TimSort。在使用该算法是正常情况下使用的临时额外空间是很小，但是最坏情况下是 n / 2，其中 n 表示待排序的数组长度（具体见 TimSort 实现）。</p>
<p>3，当插入数据因为申请不到足够的内存将会 Spill 数据到磁盘，在将最终排序结果写入到数据文件之前，需要将内存中的 PartitionedAppendOnlyMap 或者 PartitionedPairBuffer 和已经 spill 到磁盘的 SpillFiles 进行合并。Merge 的大体过程如下图。<br><img src="D:\blog\blog\source_posts\typora-user-images\merge.jpeg" alt="sparkMerge">从上图可见，大体差不多就是归并排序的过程，由此可见这个过程是没有太多额外的内存消耗。归并过程中的聚合计算大体也是差不多的过程，唯一需要注意的是键值碰撞的情况，即当前输入的各个有序队列的键值的哈希值相同，但是实际的键值不等的情况。这种情况下，需要额外的空间保存所有键值不同，但哈希值相同值的中间结果。但是总体上来说，发生这种情况的概率并不是特别大。 </p>
<p>4，写数据文件的过程涉及到不同数据流之间的转化，而在流的写入过程中，一般都有缓存，主要由参数 spark.shuffle.file.buffer 和 spark.shuffle.spill.batchSize 控制，总体上这部分开销也不大。</p>
<p>以上分析了 SortShuffleWriter write 阶段的主要过程，从中可以看出主要的内存消耗在写入 PartitionedAppendOnlyMap 或者 PartitionedPairBuffer 这个阶段。</p>
<h6 id="3-3-2-1-3-UnsafeShuffleWriter"><a href="#3-3-2-1-3-UnsafeShuffleWriter" class="headerlink" title="3.3.2.1.3 UnsafeShuffleWriter"></a>3.3.2.1.3 UnsafeShuffleWriter</h6><p>UnsafeShuffleWriter 是对 SortShuffleWriter 的优化，大体上也和 SortShuffleWriter 差不多，在此不再赘述。从内存使用角度看，主要差异在以下两点：</p>
<p>一方面，在 SortShuffleWriter 的 PartitionedAppendOnlyMap 或者 PartitionedPairBuffer 中，存储的是键值或者值的具体类型，也就是 Java 对象，是反序列化过后的数据。而在 UnsafeShuffleWriter 的 ShuffleExternalSorter 中数据是序列化以后存储到实际的 Page 中，而且在写入数据过程中会额外写入长度信息。总体而言，序列化以后数据大小是远远小于序列化之前的数据。 </p>
<p>另一方面，UnsafeShuffleWriter 中需要额外的存储记录（LongArray），它保存着分区信息和实际指向序列化后数据的指针（经过编码的Page num 以及 Offset）。相对于 SortShuffleWriter， UnsafeShuffleWriter 中这部分存储的开销是额外的。</p>
<h5 id="3-3-2-2-Shuffle-Read-阶段分析"><a href="#3-3-2-2-Shuffle-Read-阶段分析" class="headerlink" title="3.3.2.2 Shuffle Read 阶段分析"></a>3.3.2.2 Shuffle Read 阶段分析</h5><p>Spark Shuffle Read 主要经历从获取数据，序列化流，添加指标统计，可能的聚合 （Aggregation) 计算以及排序等过程。大体流程如下图。<br><img src="D:\blog\blog\source_posts\typora-user-images\shuffle_read-4.jpeg" alt="sparkRead">以上计算主要都是迭代进行。在以上步骤中，比较复杂的操作是从远程获取数据，聚合和排序操作。接下来，依次分析这三个步骤内存的使用情况。</p>
<p>1，数据获取分为远程获取和本地获取。本地获取将直接从本地的 BlockManager 取数据， 而对于远程数据，需要走网络。在远程获取过程中，有相关参数可以控制从远程并发获取数据的大小，正在获取数据的请求数，以及单次数据块请求是否放到内存等参数。具体参数包括 spark.reducer.maxSizeInFlight (默认 48M)，spark.reducer.maxReqsInFlight， spark.reducer.maxBlocksInFlightPerAddress 和 spark.maxRemoteBlockSizeFetchToMem。考虑到数据倾斜的场景，如果 Map 阶段有一个 Block 数据特别的大，默认情况由于 spark.maxRemoteBlockSizeFetchToMem 没有做限制，所以在这个阶段需要将需要获取的整个 Block 数据放到 Reduce 端的内存中，这个时候是非常的耗内存的。可以设置 spark.maxRemoteBlockSizeFetchToMem 值，如果超过该阈值，可以落盘，避免这种情况的 OOM。 另外，在获取到数据以后，默认情况下会对获取的数据进行校验（参数 spark.shuffle.detectCorrupt 控制），这个过程也增加了一定的内存消耗。</p>
<p>2，对于需要聚合和排序的情况，这个过程是借助 ExternalAppendOnlyMap 来实现的。整个插入，Spill 以及 Merge 的过程和 Write 阶段差不多。总体上，这块也是比较消耗内存的，但是因为有 Spill 操作，当内存不足时，可以将内存数据刷到磁盘，从而释放内存空间。</p>
<h4 id="3-3-3-Spark-Shuffle-OOM-可能性分析"><a href="#3-3-3-Spark-Shuffle-OOM-可能性分析" class="headerlink" title="3.3.3 Spark Shuffle OOM 可能性分析"></a>3.3.3 Spark Shuffle OOM 可能性分析</h4><p>围绕内存使用，前面比较详细的分析了 Spark 内存管理以及在 Shuffle 过程可能使用较多内存的地方。接下来总结的要点如下：</p>
<p>1，首先需要注意 Executor 端的任务并发度，多个同时运行的 Task 会共享 Executor 端的内存，使得单个 Task 可使用的内存减少。</p>
<p>2，无论是在 Map 还是在 Reduce 端，插入数据到内存，排序，归并都是比较都是比较占用内存的。因为有 Spill，理论上不会因为数据倾斜造成 OOM。 但是，由于对堆内对象的分配和释放是由 JVM 管理的，而 Spark 是通过采样获取已经使用的内存情况，有可能因为采样不准确而不能及时 Spill，导致OOM。</p>
<p>3，在 Reduce 获取数据时，由于数据倾斜，有可能造成单个 Block 的数据非常的大，默认情况下是需要有足够的内存来保存单个 Block 的数据。因此，此时极有可能因为数据倾斜造成 OOM。 可以设置 spark.maxRemoteBlockSizeFetchToMem 参数，设置这个参数以后，超过一定的阈值，会自动将数据 Spill 到磁盘，此时便可以避免因为数据倾斜造成 OOM 的情况。在我们的生产环境中也验证了这点，在设置这个参数到合理的阈值后，生产环境任务 OOM 的情况大大减少了。</p>
<p>4，在 Reduce 获取数据后，默认情况会对数据流进行解压校验（参数 spark.shuffle.detectCorrupt）。正如在代码注释中提到，由于这部分没有 Spill 到磁盘操作，也有很大的可性能会导致 OOM。在我们的生产环境中也有碰到因为检验导致 OOM 的情况。</p>
<h4 id="3-3-4-小结"><a href="#3-3-4-小结" class="headerlink" title="3.3.4 小结"></a>3.3.4 小结</h4><p>本文主要围绕内存使用这个点，对 Spark shuffle 的过程做了一个比较详细的梳理，并且分析了可能造成 OOM 的一些情况以及我们在生产环境碰到的一些问题。本文主要基于作者对 Spark 源码的理解以及实际生产过程中遇到 OOM 案例总结而成，限于经验等各方面原因，难免有所疏漏或者有失偏颇。如有问题，欢迎联系一起讨论。</p>
<h2 id="4-spark-性能调优"><a href="#4-spark-性能调优" class="headerlink" title="4. spark 性能调优"></a>4. spark 性能调优</h2><h3 id="4-1-参数调优"><a href="#4-1-参数调优" class="headerlink" title="4.1 参数调优"></a>4.1 参数调优</h3><p><img src="D:\blog\blog\source_posts\typora-user-images\1_L_-swmTl74av4hD5Cr_7Hg.png" alt="img"></p>
<p><img src="D:\blog\blog\source_posts\typora-user-images\1_vmq60Q7Vp6SHRTbpia6yyA.png" alt="img"></p>
<h3 id="4-2"><a href="#4-2" class="headerlink" title="4.2"></a>4.2</h3><h3 id="4-3-sql-调优"><a href="#4-3-sql-调优" class="headerlink" title="4.3 sql 调优"></a>4.3 sql 调优</h3>
        </div>
        <footer class="article-footer">
            



    <a data-url="http://example.com/2021/08/09/%E6%B5%8B%E8%AF%95%E8%B0%83%E4%BC%98%E6%96%87%E6%A1%A3/" data-id="cks48829w0002ion94nyw5dxp" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "author": {
            "@type": "Person",
            "name": "John Doe"
        },
        "headline": "测试调优文档",
        "image": "http://example.com./typora-user-images%5Cimage-20210807101902090-1628485681448.png",
        "keywords": "",
        "genre": "",
        "datePublished": "2021-08-09",
        "dateCreated": "2021-08-09",
        "dateModified": "2021-08-09",
        "url": "http://example.com/2021/08/09/测试调优文档/",
        "description": "

测试调优文档
1. spark基准测试1.1 测试方式1.1.1 TPC-DS1.1.2 Hibench1.2 测试结果1.2.1 TPC-DS1.2.1.1 100g数据产生12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596",
        "wordCount": 14677
    }
</script>

</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>


    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>follow:</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="stack-overflow" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-stack-overflow"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
    
        <a href="/2021/08/09/test-my-site/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">older</strong>
        <p class="article-nav-title">test_my_site</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">recents</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/08/09/%E6%B5%8B%E8%AF%95%E8%B0%83%E4%BC%98%E6%96%87%E6%A1%A3/" class="thumbnail">
    
    
        <span style="background-image:url(./typora-user-images%5Cimage-20210807101902090-1628485681448.png)" alt="测试调优文档" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2021/08/09/%E6%B5%8B%E8%AF%95%E8%B0%83%E4%BC%98%E6%96%87%E6%A1%A3/" class="title">测试调优文档</a></p>
                            <p class="item-date"><time datetime="2021-08-09T04:58:35.000Z" itemprop="datePublished">2021-08-09</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/08/09/test-my-site/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2021/08/09/test-my-site/" class="title">test_my_site</a></p>
                            <p class="item-date"><time datetime="2021-08-09T04:15:41.000Z" itemprop="datePublished">2021-08-09</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/08/09/hello-world/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2021/08/09/hello-world/" class="title">Hello World</a></p>
                            <p class="item-date"><time datetime="2021-08-09T04:13:22.317Z" itemprop="datePublished">2021-08-09</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a><span class="archive-list-count">3</span></li></ul>
        </div>
    </div>


            
                

            
                

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2021 John Doe</p>
                
                <p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="https://github.com/ppoffice" target="_blank">PPOffice</a></p>
                
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

    </div>
    
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://example.com/2021/08/09/%E6%B5%8B%E8%AF%95%E8%B0%83%E4%BC%98%E6%96%87%E6%A1%A3/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>





    
        
<script src="/libs/lightgallery/js/lightgallery.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-pager.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-zoom.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-hash.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-share.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-video.min.js"></script>

    
    
        
<script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>

    
    

    
    
    



<!-- Custom Scripts -->

<script src="/js/main.js"></script>


</body>
</html>
